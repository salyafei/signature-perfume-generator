<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Nada • Fragrance Personality Quiz</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lora:wght@400;500;600&display=swap');

        :root {
            --coral-rose: #E57F6D;
            --deep-burgundy: #800020;
            --earthy-green: #5A7A1E;
            --cream-white: #F8F8F8;
            --soft-white: #FFFFFF;
            --light-coral: #F4A89A;
            --dark-burgundy: #5C001A;
            --shadow-light: rgba(229, 127, 109, 0.2);
            --shadow-dark: rgba(128, 0, 32, 0.1);
        }

        html, body, div, h1, p, button, input, select {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lora', serif;
            background: linear-gradient(135deg, var(--cream-white) 0%, var(--soft-white) 100%);
            color: var(--deep-burgundy);
            line-height: 1.6;
            min-height: 100vh;
        }

        body[lang="ar"] {
            direction: rtl;
            text-align: center; /* Override RTL for centered elements */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, var(--soft-white) 0%, var(--cream-white) 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="%23E57F6D" opacity="0.1"/><circle cx="80" cy="40" r="1.5" fill="%236B8E23" opacity="0.1"/><circle cx="60" cy="80" r="1" fill="%23E57F6D" opacity="0.1"/></svg>') repeat;
            animation: float 20s linear infinite;
            pointer-events: none;
        }

        @keyframes float {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .logo-section {
            position: relative;
            z-index: 2;
            text-align: center;
            padding: 0 20px; /* Constrain content width */
        }

        .logo-img {
            max-width: 150px;
            height: auto;
            margin-bottom: 20px; /* Increased for spacing */
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .brand-name {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--deep-burgundy);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px var(--shadow-dark);
            letter-spacing: 2px;
            text-align: center;
        }

        .brand-tagline {
            font-size: 1.2rem;
            color: var(--earthy-green);
            font-weight: 500;
            letter-spacing: 1px;
            margin-bottom: 20px;
            margin-top: 10px; /* Added for spacing */
            text-align: center;
            display: block;
        }

        .main-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--coral-rose);
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--deep-burgundy);
            opacity: 0.8;
            text-align: center;
        }

        .intro-text {
            font-size: 1rem;
            color: var(--deep-burgundy);
            opacity: 0.85;
            margin-bottom: 15px;
            margin-top: 10px;
            line-height: 1.5;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .lang-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--coral-rose);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-family: 'Lora', serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-light);
        }

        .lang-toggle:hover, .lang-toggle:focus {
            background: var(--deep-burgundy);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-dark);
            outline: 2px solid var(--coral-rose);
            outline-offset: 2px;
        }

        .quiz-container {
            background: var(--soft-white);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 40px var(--shadow-light);
            margin-bottom: 30px;
            border: 2px solid var(--light-coral);
            position: relative;
            overflow: hidden;
        }

        .quiz-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--coral-rose), var(--deep-burgundy), var(--earthy-green));
        }

        .progress-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .progress-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--deep-burgundy);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--cream-white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px var(--shadow-dark);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--coral-rose), var(--deep-burgundy));
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .user-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--cream-white);
            border-radius: 15px;
            border: 1px solid var(--light-coral);
        }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .input-label {
            font-weight: 600;
            color: var(--deep-burgundy);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .input-field, .select-field {
            padding: 12px 15px;
            border: 2px solid var(--light-coral);
            border-radius: 10px;
            font-family: 'Lora', serif;
            font-size: 1rem;
            background: var(--soft-white);
            color: var(--deep-burgundy);
            transition: all 0.3s ease;
            height: 45px;
        }

        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: var(--coral-rose);
            box-shadow: 0 0 0 3px var(--shadow-light);
            transform: translateY(-1px);
        }

        .tooltip {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.9rem;
            color: var(--earthy-green);
            cursor: help;
        }

        .question-section {
            margin-bottom: 30px;
        }

        .question-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--deep-burgundy);
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            line-height: 1.4;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .option-card {
            background: var(--soft-white);
            border: 2px solid var(--light-coral);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            outline: none;
        }

        .option-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--shadow-light), transparent);
            transition: left 0.5s ease;
        }

        .option-card:hover::before, .option-card:focus::before {
            left: 100%;
        }

        .option-card:hover, .option-card:focus {
            border-color: var(--coral-rose);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-light);
            outline: 2px solid var(--coral-rose);
        }

        .option-card.selected {
            background: linear-gradient(135deg, var(--coral-rose), var(--light-coral));
            border-color: var(--deep-burgundy);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--shadow-dark);
        }

        .option-text {
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .nav-button {
            background: linear-gradient(135deg, var(--coral-rose), var(--deep-burgundy));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-family: 'Lora', serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .nav-button:hover::before, .nav-button:focus::before {
            left: 100%;
        }

        .nav-button:hover, .nav-button:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-dark);
            outline: 2px solid var(--coral-rose);
            outline-offset: 2px;
        }

        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .nav-button:disabled::before {
            display: none;
        }

        .result-section {
            background: var(--soft-white);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 40px var(--shadow-light);
            border: 2px solid var(--light-coral);
            margin-top: 30px;
        }

        .result-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--coral-rose);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .personality-analysis {
            background: var(--cream-white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--coral-rose);
        }

        .analysis-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--deep-burgundy);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .fragrance-composition {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .note-category {
            background: var(--soft-white);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--light-coral);
            text-align: center;
        }

        .note-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--deep-burgundy);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .note-list {
            color: var(--earthy-green);
            font-weight: 500;
        }

        .fragrance-story {
            background: linear-gradient(135deg, var(--cream-white), var(--soft-white));
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            border: 1px solid var(--light-coral);
        }

        .story-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--coral-rose);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .disclaimer {
            font-style: italic;
            color: var(--earthy-green);
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: var(--cream-white);
            border-radius: 10px;
            border: 1px solid var(--light-coral);
        }

        .al-nada-hidden {
            display: none;
            aria-hidden: true;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: var(--coral-rose);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .brand-name {
                font-size: 2.5rem;
            }
            
            .main-title {
                font-size: 2rem;
            }
            
            .user-inputs {
                flex-direction: column;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .quiz-container {
                padding: 25px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-button {
                width: 100%;
            }

            .logo-img {
                max-width: 120px;
            }

            .intro-text {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="lang-toggle" id="langToggle" aria-label="Switch to Arabic" role="button">AR</button>
        
        <div class="header">
            <div class="logo-section">
                <img src="./al-nada-logo.png" alt="Al Nada Logo" class="logo-img" onerror="console.error('Logo failed to load. Check file name: al-nada-logo.png in the same directory as index.html'); this.src='https://via.placeholder.com/150?text=Logo+Missing';" />
                <h1 class="brand-name">AL NADA</h1>
                <p class="brand-tagline">THE HOUSE OF PERFUME EXPERTS</p>
                <h2 class="main-title">Discover Your Signature Fragrance</h2>
                <p class="intro-text" data-lang="en">This questionnaire is designed to craft a signature perfume tailored to your unique personality, emotions, and memories. By answering 20 carefully curated questions, we analyze your preferences across style, emotion, fragrance family, and memory to create a bespoke fragrance blend.</p>
                <p class="intro-text" data-lang="ar" style="display: none;">هذا الاستبيان مصمم لصيغة عطر مميز يتناسب مع شخصيتك الفريدة، عواطفك، وذكرياتك. من خلال الإجابة على 20 سؤالًا تم اختيارها بعناية، نحلل تفضيلاتك عبر الأسلوب، العاطفة، عائلة العطر، والذاكرة لإنشاء مزيج عطري مخصص.</p>
                <p class="intro-text" data-lang="en">Be Honest: Your responses should reflect your true feelings and experiences. Honest answers ensure the fragrance captures your essence, from the top notes to the base. Take your time to select the option that resonates most with you.</p>
                <p class="intro-text" data-lang="ar" style="display: none;">كن صادقًا: يجب أن تعكس إجاباتك مشاعرك وتجاربك الحقيقية. الإجابات الصادقة تضمن أن يعكس العطر جوهرك، من النوتات العليا إلى القاعدة. خذ وقتك لاختيار الخيار الذي يتردد صداه معك أكثر.</p>
                <p class="intro-text" data-lang="en">Your birth date and ingredient preference (natural, synthetic, or both) add a personalized touch, aligning the blend with your seasonal vibe and values. The result is a preliminary fragrance profile, which will be refined by a professional perfume nose to perfect the harmony of the blend.</p>
                <p class="intro-text" data-lang="ar" style="display: none;">تاريخ ميلادك وتفضيلك للمكونات (طبيعية، صناعية، أو كلاهما) يضيفان لمسة شخصية، مواءمة المزيج مع أجواءك الموسمية وقيمك. النتيجة هي ملف عطري أولي، سيتم تهيئته بواسطة أنف عطري محترف لتحسين تناغم المزيج.</p>
                <p class="subtitle" id="subtitle">اكتشف عطرك الشخصي</p>
            </div>
        </div>

        <div class="quiz-container">
            <div class="progress-section">
                <div class="progress-text">
                    Question <span id="currentQ">1</span> of <span id="totalQ">20</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="user-inputs">
                <div class="input-group">
                    <label for="birthDateInput" class="input-label">Enter your birth date</label>
                    <input type="date" id="birthDateInput" class="input-field" aria-describedby="birthDateHelp" required>
                    <span id="birthDateHelp" class="al-nada-hidden">Enter a valid past date</span>
                </div>
                <div class="input-group">
                    <label for="ingredientPref" class="input-label">Ingredient Preference</label>
                    <select id="ingredientPref" class="select-field" aria-describedby="ingredientTooltip">
                        <option value="both">Natural & Synthetic</option>
                        <option value="natural">Natural Only</option>
                        <option value="synthetic">Synthetic Only</option>
                    </select>
                    <span id="ingredientTooltip" class="tooltip" title="Choose natural for plant-based notes, synthetic for modern accords, or both for a balanced blend">?</span>
                </div>
            </div>

            <div class="question-section">
                <div class="question-text" id="questionText" role="heading" aria-level="3">
                    If you could bottle one emotion, it would be...
                </div>
                <div class="options-grid" id="optionsContainer" role="listbox" aria-multiselectable="false">
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="nav-button" id="prevButton" disabled aria-label="Previous question">Previous</button>
                <button class="nav-button" id="nextButton" disabled aria-label="Next question">Next</button>
                <button class="nav-button al-nada-hidden" id="generateButton" aria-label="Generate fragrance result">Generate Result</button>
            </div>
        </div>

        <div class="result-section al-nada-hidden" id="result">
        </div>
    </div>

    <script>
        const BASE_CONFIDENCE_WEIGHT = 0.8;
        const RESPONSE_COMPLETENESS_WEIGHT = 0.2;
        const TOTAL_QUESTIONS = 20;

        const translations = {
            en: {
                resultTitle: "Your Signature Scent Profile",
                personalityAnalysis: "Personality Analysis",
                styleLabel: "Style",
                emotionLabel: "Emotion",
                fragranceFamilyLabel: "Fragrance Family",
                memoryLabel: "Memory Association",
                fragranceComposition: "Your Bespoke Fragrance Composition",
                topNotes: "Top Notes (First Impression)",
                heartNotes: "Heart Notes (Personality Core)",
                baseNotes: "Base Notes (Lasting Impression)",
                seasonalHarmony: "Seasonal Harmony",
                seasonalText: "Your {{season}} birth month adds {{character}} {{intensity}} notes that complement your natural energy.",
                fragranceStory: "Your Fragrance Story",
                storyText: "This composition tells the story of someone who is {{style}} in nature, with a {{emotion}} spirit. The {{family}} foundation reflects your preference for {{description}} experiences, while the carefully selected notes create a scent that evolves throughout the day, revealing different facets of your personality.",
                disclaimer: "Disclaimer: This advanced fragrance profile uses weighted personality analysis and intelligent note selection. A master perfumer will fine-tune the exact proportions and add bridging notes for perfect harmony and longevity.",
                styles: {
                    elegant: "Elegant",
                    bold: "Bold",
                    mysterious: "Mysterious",
                    refreshing: "Refreshing",
                    playful: "Playful",
                    sensual: "Sensual",
                    exotic: "Exotic",
                    minimalist: "Minimalist",
                    adventurous: "Adventurous",
                    classic: "Classic",
                    bohemian: "Bohemian",
                    modern: "Modern"
                },
                emotions: {
                    serenity: "Serenity",
                    confidence: "Confidence",
                    intrigue: "Intrigue",
                    joy: "Joy",
                    excitement: "Excitement",
                    romance: "Romance",
                    reflection: "Reflection",
                    passion: "Passion",
                    power: "Power",
                    melancholy: "Melancholy",
                    nostalgia: "Nostalgia",
                    curiosity: "Curiosity",
                    calm: "Calm",
                    ambition: "Ambition",
                    empathy: "Empathy"
                },
                families: {
                    oriental: "Oriental",
                    spicy: "Spicy",
                    woody: "Woody",
                    citrus: "Citrus",
                    floral: "Floral",
                    gourmand: "Gourmand",
                    aquatic: "Aquatic"
                },
                memories: {
                    reflection: "Reflection",
                    celebration: "Celebration",
                    childhood: "Childhood",
                    nature: "Nature",
                    travel: "Travel",
                    romance: "Romance"
                },
                seasons: {
                    spring: "Spring",
                    summer: "Summer",
                    autumn: "Autumn",
                    winter: "Winter"
                },
                seasonalCharacters: {
                    "fresh and blooming": "Fresh and Blooming",
                    "vibrant and energetic": "Vibrant and Energetic",
                    "warm and spicy": "Warm and Spicy",
                    "cozy and intense": "Cozy and Intense"
                },
                seasonalIntensities: {
                    light: "Light",
                    moderate: "Moderate",
                    rich: "Rich",
                    deep: "Deep"
                },
                familyDescriptions: {
                    oriental: "warm, exotic, and mysterious",
                    citrus: "fresh, energetic, and uplifting",
                    woody: "grounded, sophisticated, and natural",
                    floral: "romantic, elegant, and feminine",
                    spicy: "bold, passionate, and adventurous",
                    gourmand: "comforting, indulgent, and warm",
                    aquatic: "fresh, clean, and serene",
                    "unique and distinctive": "unique and distinctive"
                }
            },
            ar: {
                resultTitle: "ملف عطرك المميز",
                personalityAnalysis: "تحليل الشخصية",
                styleLabel: "الأسلوب",
                emotionLabel: "العاطفة",
                fragranceFamilyLabel: "عائلة العطر",
                memoryLabel: "ارتباط الذاكرة",
                fragranceComposition: "تركيبة عطرك المخصصة",
                topNotes: "النوتات العليا (الانطباع الأول)",
                heartNotes: "النوتات الوسطى (جوهر الشخصية)",
                baseNotes: "النوتات القاعدية (الانطباع الدائم)",
                seasonalHarmony: "التناغم الموسمي",
                seasonalText: "شهر ميلادك في {{season}} يضيف نوتات {{character}} {{intensity}} تكمل طاقتك الطبيعية.",
                fragranceStory: "قصة عطرك",
                storyText: "هذه التركيبة تحكي قصة شخص {{style}} بطبعه، بروح {{emotion}}. الأساس {{family}} يعكس تفضيلك لتجارب {{description}}، بينما النوتات المختارة بعناية تخلق عطرًا يتطور طوال اليوم، كاشفًا عن جوانب مختلفة من شخصيتك.",
                disclaimer: "تنويه: ملف العطر المتقدم هذا يستخدم تحليل الشخصية الموزون واختيار النوتات الذكي. سيقوم أنف عطري محترف بتهيئة النسب الدقيقة وإضافة نوتات جسرية لتحقيق التناغم والدوام المثاليين.",
                styles: {
                    elegant: "أنيق",
                    bold: "جريء",
                    mysterious: "غامض",
                    refreshing: "منعش",
                    playful: "مرح",
                    sensual: "حسي",
                    exotic: "غريب",
                    minimalist: "بسيط",
                    adventurous: "مغامر",
                    classic: "كلاسيكي",
                    bohemian: "بوهيمي",
                    modern: "عصري"
                },
                emotions: {
                    serenity: "هدوء",
                    confidence: "ثقة",
                    intrigue: "فضول",
                    joy: "فرح",
                    excitement: "حماس",
                    romance: "رومانسية",
                    reflection: "تأمل",
                    passion: "عاطفة",
                    power: "قوة",
                    melancholy: "حزن",
                    nostalgia: "حنين",
                    curiosity: "فضول",
                    calm: "سكينة",
                    ambition: "طموح",
                    empathy: "تعاطف"
                },
                families: {
                    oriental: "شرقي",
                    spicy: "حار",
                    woody: "خشبي",
                    citrus: "حمضي",
                    floral: "زهري",
                    gourmand: "غورماند",
                    aquatic: "مائي"
                },
                memories: {
                    reflection: "تأمل",
                    celebration: "احتفال",
                    childhood: "طفولة",
                    nature: "طبيعة",
                    travel: "سفر",
                    romance: "رومانسية"
                },
                seasons: {
                    spring: "الربيع",
                    summer: "الصيف",
                    autumn: "الخريف",
                    winter: "الشتاء"
                },
                seasonalCharacters: {
                    "fresh and blooming": "منعش ومزهر",
                    "vibrant and energetic": "نابض بالحياة ومليء بالطاقة",
                    "warm and spicy": "دافئ وحار",
                    "cozy and intense": "مريح ومكثف"
                },
                seasonalIntensities: {
                    light: "خفيف",
                    moderate: "معتدل",
                    rich: "غني",
                    deep: "عميق"
                },
                familyDescriptions: {
                    oriental: "دافئ، غريب، وغامض",
                    citrus: "منعش، نشيط، ومبهج",
                    woody: "متأصل، راقي، وطبيعي",
                    floral: "رومانسي، أنيق، وأنثوي",
                    spicy: "جريء، عاطفي، ومغامر",
                    gourmand: "مريح، متسامح، ودافئ",
                    aquatic: "منعش، نظيف، وساكن",
                    "unique and distinctive": "فريد ومميز"
                }
            }
        };

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return hash.toString();
        }

        const PerfumeGenerator = {
            currentQuestion: 0,
            answers: [],
            currentLang: 'en',
            cachedScore: null,
            generateClicked: false,
            responseTimes: [],
            resultCache: {},

            categories: {
                style: ["elegant", "bold", "mysterious", "refreshing", "playful", "sensual", "exotic", "minimalist", "adventurous", "classic", "bohemian", "modern"],
                emotion: ["serenity", "confidence", "intrigue", "joy", "excitement", "romance", "reflection", "passion", "power", "melancholy", "nostalgia", "curiosity", "calm", "ambition", "empathy"],
                family: ["oriental", "spicy", "woody", "citrus", "floral", "gourmand", "aquatic"],
                memory: ["reflection", "celebration", "childhood", "nature", "travel", "romance"]
            },

            pyramidNotes: {
                oriental: [
                    ["Bergamot (N)", "Pink Pepper (N)", "Cardamom Seed (N)", "Saffron (N)", "Rose Petals (N)", "Mandarin Peel (N)", "Starfruit (N)", "Clary Sage (N)", "Bitter Almond (N)", "Osmanthus (N)", "Lychee (N)", "Kumquat (N)", "Saffron-Croatian-Thread-(N)", "Rose-Turkish-Dew-(N)", "Cardamom-Indian-Pod-(N)", "Mandarin-Sicilian-Zest-(N)", "Osmanthus-Chinese-Blossom-(N)"],
                    ["Tuberose Absolute (N)", "Rose Absolute (N)", "Jasmine Sambac (N)", "Ylang-Ylang (N)", "Iris Root (N)", "Damascena Rose (N)", "Orris Butter (N)", "Saffron Absolute (N)", "Myrrh (N)", "Champaca (N)", "Gardenia Absolute (N)", "Heliotrope (N)", "Jasmine-Indian-Night-(N)", "Myrrh-Ethiopian-Resin-(N)", "Oud-Laotian-Wood-(N)", "Champaca-Indian-Flower-(N)", "Orris-Tuscan-Root-(N)"],
                    ["Vanilla Absolute (N)", "Musk Accord (B)", "Sandalwood (N)", "Amber Accord (B)", "Patchouli (N)", "Oud Assam (N)", "Benzoin Siam (N)", "Tonka Absolute (N)", "Amber Synthetic (B)", "Civet Accord (B)", "Frankincense (N)", "Peru Balsam (N)", "Amber-Persian-Resin-(B)", "Vanilla-Madagascar-Pod-(N)", "Frankincense-Omani-Tear-(N)", "Benzoin-Thai-Crystal-(N)", "Musk-Oriental-Synthetic-(B)"]
                    // Placeholder: Add ~126 more unique notes
                ],
                citrus: [
                    ["Lemon Zest (N)", "Bergamot (N)", "Grapefruit (N)", "Lime (N)", "Orange Blossom (N)", "Yuzu (N)", "Blood Orange (N)", "Clementine (N)", "Pomelo (N)", "Tangerine (N)", "Verbena (N)", "Litsea Cubeba (N)", "Lemon-Sorrento-Peel-(N)", "Grapefruit-Florida-Pink-(N)", "Bergamot-Calabrian-Rind-(N)", "Lime-Mexican-Key-(N)", "Tangerine-Moroccan-Zest-(N)"],
                    ["Neroli (N)", "Petitgrain (N)", "Lavender (N)", "Rosemary (N)", "Mint (N)", "Lemongrass (N)", "Citronella (N)", "Orange Flower (N)", "Lemon Blossom (N)", "Bergamot Flower (N)", "Kaffir Lime Leaf (N)", "Coriander Leaf (N)", "Neroli-Moroccan-Blossom-(N)", "Petitgrain-Paraguayan-Leaf-(N)", "Verbena-Moroccan-Herb-(N)", "Citron-Sicilian-Flower-(N)", "Lime-Blossom-Tahitian-(N)"],
                    ["White Musk (B)", "Cedar (N)", "Vetiver (N)", "Ambergris (N)", "Tonka Bean (N)", "Citrus Musk (B)", "Ambermax (B)", "Vetiver Haiti (N)", "Cedarwood Atlas (N)", "Iso E Super (B)", "Galbanum Resin (N)", "Lemon Cedar (N)", "Citrus-Amber-Synthetic-(B)", "Vetiver-Javanese-Root-(N)", "Cedar-Moroccan-Bark-(N)", "Ambergris-Coastal-Synthetic-(B)"]
                    // Placeholder: Add ~127 more unique notes
                ],
                woody: [
                    ["Pine Needles (N)", "Juniper (N)", "Black Pepper (N)", "Elemi (N)", "Galbanum (N)", "Hinoki Wood (N)", "Cedar Leaf (N)", "Spruce (N)", "Fir Needle (N)", "Eucalyptus Blue (N)", "Camphor (N)", "Pine Resin (N)", "Pine-Scots-Needle-(N)", "Juniper-Himalayan-Berry-(N)", "Cedar-Lebanese-Twig-(N)", "Fir-Siberian-Balsam-(N)", "Eucalyptus-Australian-Leaf-(N)"],
                    ["Cedar Heart (N)", "Sandalwood (N)", "Patchouli (N)", "Vetiver (N)", "Oakmoss (N)", "Palo Santo (N)", "Guaiac Wood (N)", "Teak (N)", "Ebony Wood (N)", "Birch Tar (N)", "Cypress (N)", "Juniper Berry (N)", "Sandalwood-Australian-Wood-(N)", "Guaiac-Paraguayan-Heart-(N)", "Cypress-Tuscan-Branch-(N)", "Teak-Burmese-Wood-(N)", "Birch-Finnish-Bark-(N)"],
                    ["Musk Base (B)", "Amber (N)", "Vanilla (N)", "Benzoin (N)", "Labdanum (N)", "Agarwood (N)", "Vetiver Bourbon (N)", "Sandalwood Mysore (N)", "Cashmeran (B)", "Ambroxan (B)", "Cedarwood Virginia (N)", "Oakwood Absolute (N)", "Oud-Cambodian-Resin-(N)", "Vetiver-Madagascan-Root-(N)", "Ambrox-Synthetic-(B)", "Cedar-Himalayan-Base-(N)"]
                    // Placeholder: Add ~127 more unique notes
                ],
                floral: [
                    ["Angelica Flower (N)", "Cumin (N)", "Cardamom Seed (N)", "Pink Grapefruit (N)", "Bergamot (N)", "Freesia (N)", "Hyacinth (N)", "Neroli Tunisia (N)", "Mimosa (N)", "Violet Leaf (N)", "Linden Blossom (N)", "Apple Blossom (N)", "Violet-French-Leaf-(N)", "Mimosa-Australian-Bloom-(N)", "Hyacinth-Dutch-Flower-(N)", "Freesia-SouthAfrican-Petal-(N)", "Linden-German-Blossom-(N)"],
                    ["Rose Absolute (N)", "Jasmine (N)", "Peony (N)", "Lily of the Valley (N)", "Magnolia (N)", "Tiare Flower (N)", "Frangipani (N)", "Carnation (N)", "Lilac (N)", "Iris Pallida (N)", "Rose de Mai (N)", "Jasmine Grandiflorum (N)", "Rose-Bulgarian-Oil-(N)", "Jasmine-Sambac-Indian-(N)", "Frangipani-Balinese-Flower-(N)", "Lilac-Syracuse-Bloom-(N)", "Carnation-Spanish-Petal-(N)"],
                    ["White Musk (B)", "Sandalwood (N)", "Amber (N)", "Vanilla (N)", "Iris (N)", "Vanilla Tahiti (N)", "Amber Floral (B)", "Musk Ketone (B)", "Orris Concrete (N)", "Sandalwood Album (N)", "Tuberose Wax (N)", "Ylang Absolute (N)", "Iris-Florentine-Rhizome-(N)", "Vanilla-Orchid-Tahitian-(N)", "Musk-Floral-Synthetic-(B)", "Amber-Rose-Synthetic-(B)"]
                    // Placeholder: Add ~127 more unique notes
                ],
                spicy: [
                    ["Black Pepper (N)", "Cinnamon (N)", "Nutmeg (N)", "Clove (N)", "Ginger (N)", "Pink Peppercorn (N)", "Allspice (N)", "Anise Seed (N)", "Caraway (N)", "Coriander Seed (N)", "Fennel Seed (N)", "Saffron Thread (N)", "Pepper-Madagascan-Black-(N)", "Anise-Turkish-Seed-(N)", "Coriander-Russian-Seed-(N)", "Fennel-Italian-Seed-(N)", "Saffron-Iranian-Stigma-(N)"],
                    ["Cardamom (N)", "Star Anise (N)", "Bay Leaves (N)", "Thyme (N)", "Rosemary (N)", "Turmeric (N)", "Cumin Seed (N)", "Fenugreek (N)", "Pimento Berry (N)", "Chili Pepper (N)", "Cardamom Green (N)", "Ginger Root (N)", "Ginger-Zanzibar-Root-(N)", "Cardamom-Guatemalan-Pod-(N)", "Cumin-Egyptian-Seed-(N)", "Turmeric-Indian-Root-(N)", "Pimento-Jamaican-Berry-(N)"],
                    ["Sandalwood (N)", "Cedar (N)", "Patchouli (N)", "Vanilla (N)", "Musk (B)", "Leather Accord (B)", "Tobacco Leaf (N)", "Clove Bud (N)", "Cinnamon Bark (N)", "Oud Synthetic (B)", "Amber Spicy (B)", "Patchouli Dark (N)", "Clove-Zanzibar-Bud-(N)", "Tobacco-Cuban-Leaf-(N)", "Leather-Spanish-Accord-(B)", "Oud-Indian-Synthetic-(B)"]
                    // Placeholder: Add ~127 more unique notes
                ],
                gourmand: [
                    ["Vanilla (N)", "Caramel (B)", "Coffee (N)", "Chocolate (B)", "Honey (N)", "Candied Orange (N)", "Toffee (B)", "Maple Syrup (N)", "Roasted Hazelnut (N)", "Pear Nectar (N)", "Cherry Cordial (N)", "Fig Fruit (N)", "Fig-Sicilian-Fruit-(N)", "Pear-Anjou-Juice-(N)", "Cherry-Tart-Michigan-(N)", "Orange-Candied-Spanish-(N)", "Hazelnut-Italian-Roasted-(N)"],
                    ["Almond (N)", "Coconut (N)", "Praline (B)", "Cinnamon (N)", "Tonka Bean (N)", "Butterscotch (B)", "Creme Brulee (B)", "Dulce de Leche (B)", "Marzipan (N)", "Chestnut Cream (N)", "Cocoa Powder (N)", "Honeycomb (N)", "Cocoa-Venezuelan-Bean-(N)", "Honey-French-Lavender-(N)", "Marzipan-German-Paste-(N)", "Chestnut-Tuscan-Roast-(N)", "Toffee-English-Sticky-(B)"],
                    ["Musk (B)", "Amber (N)", "Sandalwood (N)", "Benzoin (N)", "Vanilla Base (N)", "Vanilla Bourbon (N)", "Tonka Bean Absolute (N)", "Benzoin Resin (N)", "Caramelized Sugar (B)", "Chocolate Absolute (N)", "Coffee Absolute (N)", "Musk Gourmand (B)", "Vanilla-Reunion-Bean-(N)", "Tonka-Brazilian-Bean-(N)", "Caramel-French-Burnt-(B)", "Chocolate-Mexican-Dark-(N)", "Coffee-Ethiopian-Roast-(N)"]
                    // Placeholder: Add ~126 more unique notes
                ],
                aquatic: [
                    ["Sea Salt (B)", "Marine Accord (B)", "Cucumber (N)", "Mint (N)", "Eucalyptus (N)", "Sea Breeze Accord (B)", "Watermelon (N)", "Calone (B)", "Ozonic Accord (B)", "Aloe Vera (N)", "Cucumber Peel (N)", "Lotus Leaf (N)", "Melon-Cantaloupe-French-(N)", "Cucumber-English-Seed-(N)", "Aloe-SouthAfrican-Gel-(N)", "Lotus-Egyptian-Leaf-(N)", "Ozonic-Pacific-Breeze-(B)"],
                    ["Water Lily (N)", "Lotus (N)", "Seaweed (N)", "Driftwood (N)", "Rain Accord (B)", "Sea Foam (B)", "Kelp (N)", "Water Hyacinth (N)", "Blue Lotus (N)", "Coral Accord (B)", "Aquamarine Accord (B)", "Driftwood Salt (N)", "Hyacinth-Water-Dutch-(N)", "Kelp-Icelandic-Sea-(N)", "Coral-Caribbean-Accord-(B)", "Seafoam-Atlantic-Spray-(B)", "Lotus-Indian-Blue-(N)"],
                    ["Ambergris (N)", "White Musk (B)", "Cedar (N)", "Sandalwood (N)", "Mineral Accord (B)", "Marine Musk (B)", "Ambergris Synthetic (B)", "Salty Amber (B)", "Sea Moss (N)", "Ocean Wood (N)", "Mineral Salt (B)", "Coastal Cedar (N)", "Amber-Sea-Synthetic-(B)", "Musk-Oceanic-Synthetic-(B)", "Cedar-Driftwood-Coastal-(N)", "Moss-Irish-Sea-(N)"]
                    // Placeholder: Add ~127 more unique notes
                ]
            },

            traitToNoteMap: {
                elegant: ["Rose Absolute (N)", "Iris (N)", "Vanilla Absolute (N)", "Damascena Rose (N)", "Orris Butter (N)", "Rose-Bulgarian-Oil-(N)", "Iris-Florentine-Rhizome-(N)"],
                bold: ["Black Pepper (N)", "Ginger (N)", "Nutmeg (N)", "Pink Peppercorn (N)", "Clove Bud (N)", "Pepper-Madagascan-Black-(N)", "Clove-Zanzibar-Bud-(N)"],
                mysterious: ["Patchouli (N)", "Oakmoss (N)", "Musk Accord (B)", "Oud Assam (N)", "Myrrh (N)", "Oud-Cambodian-Resin-(N)", "Myrrh-Ethiopian-Resin-(N)"],
                refreshing: ["Lemon Zest (N)", "Mint (N)", "Sea Salt (B)", "Yuzu (N)", "Calone (B)", "Lemon-Sorrento-Peel-(N)", "Ozonic-Pacific-Breeze-(B)"],
                playful: ["Orange Blossom (N)", "Praline (B)", "Caramel (B)", "Candied Orange (N)", "Cherry Cordial (N)", "Cherry-Tart-Michigan-(N)", "Caramel-French-Burnt-(B)"],
                sensual: ["Jasmine Sambac (N)", "Ylang-Ylang (N)", "Amber Accord (B)", "Tiare Flower (N)", "Frangipani (N)", "Jasmine-Sambac-Indian-(N)", "Frangipani-Balinese-Flower-(N)"],
                exotic: ["Saffron (N)", "Cardamom Seed (N)", "Star Anise (N)", "Saffron Thread (N)", "Anise Seed (N)", "Saffron-Iranian-Stigma-(N)", "Cardamom-Guatemalan-Pod-(N)"],
                minimalist: ["Cedar (N)", "White Musk (B)", "Mineral Accord (B)", "Coastal Cedar (N)", "Aquamarine Accord (B)", "Cedar-Driftwood-Coastal-(N)", "Musk-Oceanic-Synthetic-(B)"],
                adventurous: ["Juniper (N)", "Elemi (N)", "Vetiver (N)", "Hinoki Wood (N)", "Palo Santo (N)", "Juniper-Himalayan-Berry-(N)", "Vetiver-Madagascan-Root-(N)"],
                classic: ["Bergamot (N)", "Sandalwood (N)", "Tonka Bean (N)", "Vanilla Tahiti (N)", "Neroli Tunisia (N)", "Bergamot-Calabrian-Rind-(N)", "Vanilla-Reunion-Bean-(N)"],
                bohemian: ["Pink Pepper (N)", "Rose Petals (N)", "Driftwood (N)", "Mimosa (N)", "Linden Blossom (N)", "Mimosa-Australian-Bloom-(N)", "Violet-French-Leaf-(N)"],
                modern: ["Petitgrain (N)", "Marine Accord (B)", "Ambergris (N)", "Ozonic Accord (B)", "Iso E Super (B)", "Petitgrain-Paraguayan-Leaf-(N)", "Amber-Sea-Synthetic-(B)"],
                serenity: ["Lavender (N)", "Water Lily (N)", "Vanilla (N)", "Lotus Leaf (N)", "Blue Lotus (N)", "Lotus-Indian-Blue-(N)", "Hyacinth-Water-Dutch-(N)"],
                confidence: ["Cedar Heart (N)", "Musk (B)", "Clove (N)", "Cedarwood Atlas (N)", "Tobacco Leaf (N)", "Cedar-Moroccan-Bark-(N)", "Tobacco-Cuban-Leaf-(N)"],
                intrigue: ["Tuberose Absolute (N)", "Rain Accord (B)", "Labdanum (N)", "Saffron Absolute (N)", "Civet Accord (B)", "Oud-Laotian-Wood-(N)", "Champaca-Indian-Flower-(N)"],
                joy: ["Grapefruit (N)", "Coconut (N)", "Lime (N)", "Blood Orange (N)", "Watermelon (N)", "Grapefruit-Florida-Pink-(N)", "Melon-Cantaloupe-French-(N)"],
                excitement: ["Cinnamon (N)", "Bay Leaves (N)", "Pink Grapefruit (N)", "Allspice (N)", "Pimento Berry (N)", "Pimento-Jamaican-Berry-(N)", "Ginger-Zanzibar-Root-(N)"],
                romance: ["Rose Absolute (N)", "Magnolia (N)", "Honey (N)", "Rose de Mai (N)", "Carnation (N)", "Rose-Bulgarian-Oil-(N)", "Carnation-Spanish-Petal-(N)"],
                reflection: ["Sandalwood Base (N)", "Benzoin (N)", "Iris Root (N)", "Benzoin Siam (N)", "Orris Concrete (N)", "Benzoin-Thai-Crystal-(N)", "Iris-Florentine-Rhizome-(N)"],
                passion: ["Nutmeg (N)", "Jasmine (N)", "Amber (N)", "Chili Pepper (N)", "Cinnamon Bark (N)", "Nutmeg-Madagascan-Seed-(N)", "Jasmine-Sambac-Indian-(N)"],
                power: ["Black Pepper (N)", "Sandalwood (N)", "Musk Base (B)", "Oud Synthetic (B)", "Leather Accord (B)", "Oud-Indian-Synthetic-(B)", "Leather-Spanish-Accord-(B)"],
                melancholy: ["Seaweed (N)", "Oakmoss (N)", "Vanilla Base (N)", "Kelp (N)", "Sea Moss (N)", "Kelp-Icelandic-Sea-(N)", "Moss-Irish-Sea-(N)"],
                nostalgia: ["Almond (N)", "Coffee (N)", "Caramel (B)", "Chestnut Cream (N)", "Cocoa Powder (N)", "Cocoa-Venezuelan-Bean-(N)", "Coffee-Ethiopian-Roast-(N)"],
                curiosity: ["Cumin (N)", "Star Anise (N)", "Eucalyptus (N)", "Fenugreek (N)", "Coriander Seed (N)", "Cumin-Egyptian-Seed-(N)", "Anise-Turkish-Seed-(N)"],
                calm: ["Lotus (N)", "Mint (N)", "White Musk (B)", "Water Hyacinth (N)", "Aloe Vera (N)", "Hyacinth-Water-Dutch-(N)", "Aloe-SouthAfrican-Gel-(N)"],
                ambition: ["Cardamom (N)", "Ginger (N)", "Cedar (N)", "Cardamom Green (N)", "Turmeric (N)", "Cardamom-Guatemalan-Pod-(N)", "Turmeric-Indian-Root-(N)"],
                empathy: ["Peony (N)", "Lily of the Valley (N)", "Vanilla (N)", "Lilac (N)", "Honeycomb (N)", "Lilac-Syracuse-Bloom-(N)", "Honey-French-Lavender-(N)"]
            },

            seasonalInfluence: {
                spring: { character: "fresh and blooming", intensity: "light" },
                summer: { character: "vibrant and energetic", intensity: "moderate" },
                autumn: { character: "warm and spicy", intensity: "rich" },
                winter: { character: "cozy and intense", intensity: "deep" }
            },

            questions: [
                {
                    en: "If you could bottle one emotion, it would be...",
                    ar: "إذا كان بإمكانك تعبئة عاطفة واحدة، فستكون...",
                    options: [
                        ["Serene contentment", "رضا هادئ", ["elegant", "serenity", "oriental", "reflection"]],
                        ["Fierce confidence", "ثقة شرسة", ["bold", "confidence", "spicy", "celebration"]],
                        ["Deep intrigue", "فضول عميق", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["Pure joy", "فرح خالص", ["refreshing", "joy", "citrus", "celebration"]],
                        ["Adventurous zeal", "حماس مغامر", ["playful", "excitement", "citrus", "travel"]],
                        ["Romantic nostalgia", "حنين رومانسي", ["sensual", "romance", "floral", "romance"]]
                    ]
                },
                {
                    en: "Your ideal evening setting would be...",
                    ar: "إعداد المساء المثالي لك سيكون...",
                    options: [
                        ["Candlelit salon with soft music", "صالون بالشموع مع موسيقى هادئة", ["elegant", "serenity", "oriental", "romance"]],
                        ["Bold pop-art gallery with bright lights", "معرض فن شعبي جريء مع أضواء ساطعة", ["bold", "confidence", "citrus", "celebration"]],
                        ["Secluded reading nook by the fireplace", "زاوية قراءة منعزلة بجانب المدفأة", ["mysterious", "reflection", "woody", "reflection"]],
                        ["Sunset beach bonfire with close friends", "نار شاطئية عند الغروب مع الأصدقاء المقربين", ["refreshing", "joy", "aquatic", "nature"]],
                        ["Vibrant rooftop dance floor under stars", "حلبة رقص نابضة بالحياة على السطح تحت النجوم", ["playful", "excitement", "citrus", "celebration"]],
                        ["Lush garden brunch at sunrise", "فطور متأخر في حديقة خضراء عند شروق الشمس", ["sensual", "joy", "floral", "nature"]]
                    ]
                },
                {
                    en: "A cherished childhood memory involves...",
                    ar: "ذكرى طفولة عزيزة تتضمن...",
                    options: [
                        ["Baking cookies with family", "خبز البسكويت مع العائلة", ["sensual", "joy", "gourmand", "childhood"]],
                        ["Building forts outdoors", "بناء الحصون في الهواء الطلق", ["bold", "excitement", "woody", "childhood"]],
                        ["Bedtime stories by lamplight", "قصص ما قبل النوم تحت ضوء المصباح", ["mysterious", "serenity", "oriental", "childhood"]],
                        ["Running barefoot on wet grass", "الجري حافي القدمين على العشب المبلل", ["refreshing", "joy", "aquatic", "nature"]],
                        ["Blowing bubbles in the park", "نفخ الفقاعات في الحديقة", ["playful", "joy", "citrus", "childhood"]],
                        ["Riding a carousel at a fair", "ركوب الدوامة في المعرض", ["elegant", "romance", "floral", "childhood"]]
                    ]
                },
                {
                    en: "Your dream landscape painting would feature...",
                    ar: "لوحة المناظر الطبيعية الحلم ستتضمن...",
                    options: [
                        ["Moonlit forest with silvery mist", "غابة مقمرة مع ضباب فضي", ["mysterious", "serenity", "woody", "nature"]],
                        ["Blazing sunset over desert dunes", "غروب ملتهب فوق كثبان الصحراء", ["bold", "passion", "spicy", "nature"]],
                        ["Stately manor's rose garden", "حديقة ورود قصر فخم", ["elegant", "romance", "floral", "romance"]],
                        ["Blue-white seascape at dawn", "منظر بحري أزرق-أبيض عند الفجر", ["refreshing", "serenity", "aquatic", "nature"]],
                        ["Colorful spice market at noon", "سوق التوابل الملون في الظهيرة", ["playful", "excitement", "spicy", "travel"]],
                        ["Quiet temple courtyard", "فناء معبد هادئ", ["elegant", "reflection", "oriental", "reflection"]]
                    ]
                },
                {
                    en: "Your perfect Sunday morning activity is...",
                    ar: "نشاط صباح الأحد المثالي هو...",
                    options: [
                        ["Journaling by a window", "كتابة اليوميات بجانب النافذة", ["elegant", "reflection", "woody", "reflection"]],
                        ["High-intensity workout", "تمرين عالي الكثافة", ["bold", "power", "spicy", "celebration"]],
                        ["Long forest hike", "نزهة طويلة في الغابة", ["mysterious", "serenity", "woody", "nature"]],
                        ["Brunch on a sunny terrace", "فطور متأخر على شرفة مشمسة", ["sensual", "joy", "floral", "romance"]],
                        ["Dancing to upbeat tunes", "الرقص على أنغام حيوية", ["playful", "joy", "citrus", "celebration"]],
                        ["Calligraphy in cozy studio", "الخط في استوديو مريح", ["elegant", "serenity", "oriental", "reflection"]]
                    ]
                },
                {
                    en: "Your favorite literary genre is...",
                    ar: "نوعك الأدبي المفضل هو...",
                    options: [
                        ["Classic romance", "رومانسية كلاسيكية", ["sensual", "romance", "floral", "romance"]],
                        ["Adventure thrillers", "إثارة المغامرات", ["bold", "excitement", "spicy", "travel"]],
                        ["Mysteries & gothic", "الألغاز والقوطية", ["mysterious", "intrigue", "oriental", "reflection"]],
                        ["Travel memoirs", "مذكرات السفر", ["refreshing", "excitement", "citrus", "travel"]],
                        ["Light comedies", "كوميديات خفيفة", ["playful", "joy", "citrus", "celebration"]],
                        ["Philosophical poetry", "شعر فلسفي", ["elegant", "reflection", "woody", "reflection"]]
                    ]
                },
                {
                    en: "Your ideal film scene would be...",
                    ar: "مشهد الفيلم المثالي سيكون...",
                    options: [
                        ["Intimate by candlelight", "حميم على ضوء الشموع", ["sensual", "romance", "oriental", "romance"]],
                        ["Explosive action abroad", "حركة انفجارية في الخارج", ["bold", "power", "spicy", "travel"]],
                        ["Haunting close-ups", "لقطات مقربة مخيفة", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["Reflective nature montages", "مونتاج طبيعي تأملي", ["refreshing", "serenity", "aquatic", "nature"]],
                        ["Joyful musicals", "موسيقيات مفرحة", ["playful", "joy", "citrus", "celebration"]],
                        ["Surreal dreamscapes", "مناظر أحلام سريالية", ["elegant", "intrigue", "oriental", "reflection"]]
                    ]
                },
                {
                    en: "Your signature jewelry piece would be...",
                    ar: "قطعة المجوهرات المميزة ستكون...",
                    options: [
                        ["Rose-gold locket", "قلادة من الذهب الوردي", ["elegant", "romance", "floral", "romance"]],
                        ["Statement cuff", "سوار بيان", ["bold", "confidence", "spicy", "celebration"]],
                        ["Oxidized pendant", "قلادة مؤكسدة", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["Wooden bead bracelet", "سوار خرز خشبي", ["refreshing", "serenity", "woody", "nature"]],
                        ["Turquoise ring", "خاتم فيروزي", ["playful", "joy", "aquatic", "travel"]],
                        ["Silver band", "خاتم فضي", ["elegant", "serenity", "oriental", "reflection"]]
                    ]
                },
                {
                    en: "Your preferred lighting ambiance is...",
                    ar: "أجواء الإضاءة المفضلة هي...",
                    options: [
                        ["Soft candle glow", "توهج شمعة ناعم", ["sensual", "romance", "oriental", "romance"]],
                        ["Neon club strobes", "أضواء النيون الوامضة", ["bold", "excitement", "citrus", "celebration"]],
                        ["Moody lamps", "مصابيح مزاجية", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["Cool daylight", "ضوء النهار البارد", ["refreshing", "serenity", "aquatic", "nature"]],
                        ["Warm Edison bulbs", "مصابيح إديسون الدافئة", ["playful", "joy", "woody", "childhood"]],
                        ["Lantern at twilight", "فانوس عند الغسق", ["elegant", "serenity", "oriental", "reflection"]]
                    ]
                },
                {
                    en: "Your ideal social gathering is...",
                    ar: "التجمع الاجتماعي المثالي هو...",
                    options: [
                        ["Dusk gathering", "تجمع الغسق", ["elegant", "serenity", "oriental", "romance"]],
                        ["All-night party", "حفلة طوال الليل", ["bold", "excitement", "citrus", "celebration"]],
                        ["Secret lounge", "صالة سرية", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["Beachside picnic", "نزهة على الشاطئ", ["refreshing", "joy", "aquatic", "nature"]],
                        ["Rooftop dance", "رقص على السطح", ["playful", "excitement", "citrus", "celebration"]],
                        ["Garden poetry", "شعر في الحديقة", ["sensual", "romance", "floral", "romance"]]
                    ]
                },
                {
                    en: "If you could bottle one emotion, it would be...",
                    ar: "إذا كان بإمكانك تعبئة عاطفة واحدة، فستكون...",
                    options: [
                        ["Serene contentment", "رضا هادئ", ["elegant", "serenity", "oriental", "reflection"]],
                        ["Fierce confidence", "ثقة شرسة", ["bold", "confidence", "spicy", "celebration"]],
                        ["Deep intrigue", "فضول عميق", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["Pure joy", "فرح خالص", ["refreshing", "joy", "citrus", "celebration"]],
                        ["Adventurous zeal", "حماس مغامر", ["playful", "excitement", "citrus", "travel"]],
                        ["Romantic nostalgia", "حنين رومانسي", ["sensual", "romance", "floral", "romance"]]
                    ]
                },
                {
                    en: "When choosing a meal, you're most drawn to...",
                    ar: "عند اختيار وجبة، تنجذب أكثر إلى...",
                    options: [
                        ["Artful plating", "تقديم فني", ["elegant", "serenity", "oriental", "reflection"]],
                        ["Spicy bold flavors", "نكهات حارة وجريئة", ["bold", "passion", "spicy", "celebration"]],
                        ["Rich slow-cooked stews", "أطباق مطبوخة ببطء وغنية", ["sensual", "gourmand", "woody", "childhood"]],
                        ["Fresh farm-to-table", "طازج من المزرعة", ["refreshing", "joy", "citrus", "nature"]],
                        ["Sweet playful desserts", "حلويات حلوة ومرحة", ["playful", "joy", "gourmand", "celebration"]],
                        ["Comfort classics", "أطباق الراحة التقليدية", ["elegant", "joy", "woody", "reflection"]]
                    ]
                },
                {
                    en: "In conversation, you prefer topics that are...",
                    ar: "في الحديث، تفضل المواضيع التي تكون...",
                    options: [
                        ["Philosophical & reflective", "فلسفية وتأملية", ["elegant", "reflection", "woody", "reflection"]],
                        ["Challenging & ambitious", "تحدي وطموح", ["bold", "confidence", "spicy", "celebration"]],
                        ["Mysterious & speculative", "غامضة ومتنبئة", ["mysterious", "intrigue", "oriental", "reflection"]],
                        ["Heartwarming & sincere", "دافئة وصادقة", ["sensual", "joy", "floral", "romance"]],
                        ["Energetic & fun", "نشيطة وممتعة", ["playful", "joy", "citrus", "celebration"]],
                        ["Cultural & worldly", "ثقافية وعالمية", ["exotic", "excitement", "woody", "travel"]]
                    ]
                },
                {
                    en: "Which piece of music stirs you most?",
                    ar: "أي قطعة موسيقية تحركك أكثر؟",
                    options: [
                        ["Soft piano nocturne", "مقطوعة بيانو هادئة", ["elegant", "serenity", "woody", "reflection"]],
                        ["Driving rock anthem", "أنشودة روك قوية", ["bold", "passion", "spicy", "celebration"]],
                        ["Eerie ambient track", "مقطوعة بيئية غامضة", ["mysterious", "intrigue", "oriental", "reflection"]],
                        ["Gentle acoustic ballad", "أغنية بلادي هادئة", ["sensual", "romance", "floral", "romance"]],
                        ["Lively dance beat", "إيقاع رقص حيوي", ["playful", "joy", "citrus", "celebration"]],
                        ["Haunting world chant", "ترنيمة عالمية مخيفة", ["exotic", "intrigue", "oriental", "travel"]]
                    ]
                },
                {
                    en: "If you gifted someone a place to stay, it would be...",
                    ar: "إذا أهديت مكان إقامة، فسيكون...",
                    options: [
                        ["Serene mountain cabin", "كوخ جبلي هادئ", ["mysterious", "serenity", "woody", "nature"]],
                        ["Chic urban loft", "شقة حضرية أنيقة", ["bold", "confidence", "citrus", "celebration"]],
                        ["Hidden historic villa", "فيلا تاريخية مخفية", ["mysterious", "intrigue", "oriental", "reflection"]],
                        ["Beachside bungalow", "بنغل على الشاطئ", ["refreshing", "joy", "aquatic", "nature"]],
                        ["Trendy boutique hostel", "نزل بوتيكي عصري", ["playful", "joy", "floral", "celebration"]],
                        ["Luxurious spa resort", "منتجع سبا فاخر", ["elegant", "romance", "oriental", "romance"]]
                    ]
                },
                {
                    en: "Which pastime speaks to your soul?",
                    ar: "أي هواية تنادي روحك؟",
                    options: [
                        ["Painting or sketching", "الرسم أو التخطيط", ["elegant", "reflection", "floral", "reflection"]],
                        ["Competitive sports", "رياضات تنافسية", ["bold", "power", "spicy", "celebration"]],
                        ["Creative writing", "الكتابة الإبداعية", ["mysterious", "intrigue", "oriental", "reflection"]],
                        ["Gardening or birdwatching", "البستنة أو مراقبة الطيور", ["sensual", "serenity", "woody", "nature"]],
                        ["Party-hosting & socializing", "استضافة الحفلات والتواصل الاجتماعي", ["playful", "joy", "citrus", "celebration"]],
                        ["Meditation & yoga", "التأمل واليوغا", ["elegant", "serenity", "woody", "reflection"]]
                    ]
                },
                {
                    en: "At a party, you're most often found...",
                    ar: "في الحفلة، تجد نفسك غالبًا...",
                    options: [
                        ["In a quiet corner chatting", "في زاوية هادئة تتحدث", ["elegant", "reflection", "oriental", "reflection"]],
                        ["Leading the dance floor", "تقود حلبة الرقص", ["bold", "passion", "spicy", "celebration"]],
                        ["Observing from shadows", "ترصد من الظلال", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["Helping the host", "مساعدة المضيف", ["sensual", "joy", "floral", "romance"]],
                        ["Capturing candid photos", "التقاط صور عفوية", ["playful", "joy", "citrus", "childhood"]],
                        ["Mingling across groups", "التواصل مع الجميع", ["exotic", "confidence", "woody", "travel"]]
                    ]
                },
                {
                    en: "Your perfect getaway includes...",
                    ar: "عطلتك المثالية تتضمن...",
                    options: [
                        ["A silent retreat", "منتجع صامت", ["mysterious", "serenity", "woody", "reflection"]],
                        ["Multi-city tour", "جولة متعددة المدن", ["bold", "confidence", "citrus", "travel"]],
                        ["Stay in ancient citadel", "إقامة في قلعة قديمة", ["mysterious", "intrigue", "oriental", "reflection"]],
                        ["Nature lodge by a lake", "منتجع طبيعي بجانب البحيرة", ["refreshing", "joy", "aquatic", "nature"]],
                        ["Beachside festival", "مهرجان على الشاطئ", ["playful", "joy", "citrus", "celebration"]],
                        ["Historic mansion stay", "إقامة في قصر تاريخي", ["elegant", "romance", "floral", "romance"]]
                    ]
                },
                {
                    en: "Which fabric texture feels most luxurious?",
                    ar: "أي نسيج يبدو الأكثر فخامة؟",
                    options: [
                        ["Silky satin", "ساتان حريري", ["sensual", "romance", "oriental", "romance"]],
                        ["Embossed leather", "جلد منقوش", ["bold", "power", "spicy", "celebration"]],
                        ["Raw velvet", "مخمل خام", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["Crisp linen", "كتان مقرمش", ["refreshing", "serenity", "citrus", "nature"]],
                        ["Breathable cotton", "قطن تنفسي", ["playful", "joy", "floral", "childhood"]],
                        ["Cashmere wool", "صوف الكشمير", ["elegant", "serenity", "woody", "reflection"]]
                    ]
                },
                {
                    en: "When you reminisce, you recall...",
                    ar: "عندما تسترجع الذكريات، تتذكر...",
                    options: [
                        ["First meaningful conversation", "أولى محادثة ذات مغزى", ["elegant", "romance", "oriental", "reflection"]],
                        ["A triumphant achievement", "إنجاز انتصاري", ["bold", "confidence", "spicy", "celebration"]],
                        ["A secret you never shared", "سر لم تشاركه", ["mysterious", "intrigue", "woody", "reflection"]],
                        ["A peaceful childhood afternoon", "بعد ظهر طفولة هادئ", ["sensual", "serenity", "floral", "childhood"]],
                        ["A spontaneous road trip", "رحلة برية عفوية", ["playful", "excitement", "citrus", "travel"]],
                        ["A milestone celebration", "احتفال بمعلم مهم", ["elegant", "joy", "floral", "celebration"]]
                    ]
                }
            ],

            questionWeights: {
                0: 1.5, 1: 1.3, 2: 1.2, 3: 1.1, 4: 1.0, 5: 1.4, 6: 1.3, 7: 1.0, 8: 1.0, 9: 1.1,
                10: 1.5, 11: 1.2, 12: 1.3, 13: 1.4, 14: 1.1, 15: 1.2, 16: 1.1, 17: 1.0, 18: 1.0, 19: 1.3
            },

            // Generate a unique session ID for in-memory caching
            sessionId: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,

            init: function() {
                try {
                    console.log(`Initializing PerfumeGenerator, session ID: ${this.sessionId}`);
                    const requiredElements = [
                        'langToggle', 'questionText', 'optionsContainer', 'currentQ',
                        'totalQ', 'progressFill', 'prevButton', 'nextButton',
                        'generateButton', 'subtitle', 'birthDateInput', 'ingredientPref', 'result'
                    ];
                    for (const id of requiredElements) {
                        if (!document.getElementById(id)) {
                            throw new Error(`Required DOM element #${id} not found`);
                        }
                    }

                    this.initScore();
                    this.responseTimes = new Array(TOTAL_QUESTIONS).fill(null);

                    // Ensure quiz container is visible and result is hidden
                    const quizContainer = document.querySelector('.quiz-container');
                    const resultDiv = document.getElementById('result');
                    if (quizContainer) quizContainer.classList.remove('al-nada-hidden');
                    if (resultDiv) resultDiv.classList.add('al-nada-hidden');

                    this.displayQuestion();
                    this.setupEventListeners();

                    window.addEventListener('beforeunload', (e) => {
                        if (this.answers.length > 0 && !document.getElementById('result').innerHTML) {
                            e.preventDefault();
                            e.returnValue = 'You have unsaved quiz answers. Are you sure you want to leave?';
                        }
                    });

                    // Clear resultCache on session end
                    window.addEventListener('unload', () => {
                        console.log(`Clearing result cache for session: ${this.sessionId}`);
                        this.resultCache = {};
                    });
                } catch (error) {
                    console.error('Initialization failed:', error);
                    alert('An error occurred while loading the quiz. Please refresh the page.');
                }
            },

            initScore: function() {
                this.score = {};
                for (let category in this.categories) {
                    this.score[category] = {};
                    this.categories[category].forEach(item => {
                        this.score[category][item] = 0;
                    });
                }
                this.cachedScore = null;
            },

            setupEventListeners: function() {
                try {
                    console.log('Setting up event listeners...');
                    const langToggle = document.getElementById('langToggle');
                    const prevButton = document.getElementById('prevButton');
                    const nextButton = document.getElementById('nextButton');
                    const generateButton = document.getElementById('generateButton');
                    const optionsContainer = document.getElementById('optionsContainer');
                    const birthDateInput = document.getElementById('birthDateInput');

                    if (!langToggle || !prevButton || !nextButton || !generateButton || !optionsContainer || !birthDateInput) {
                        throw new Error('Event listener elements not found');
                    }

                    langToggle.addEventListener('click', () => this.toggleLanguage());
                    prevButton.addEventListener('click', () => this.previousQuestion());
                    nextButton.addEventListener('click', () => this.nextQuestion());
                    generateButton.addEventListener('click', () => this.generateResult());
                    optionsContainer.addEventListener('click', (e) => {
                        const optionCard = e.target.closest('.option-card');
                        if (optionCard) {
                            const index = Array.from(optionsContainer.children).indexOf(optionCard);
                            this.selectOption(index, optionCard);
                        }
                    });
                    optionsContainer.addEventListener('keydown', (e) => {
                        const optionCard = e.target.closest('.option-card');
                        if (optionCard && (e.key === 'Enter' || e.key === ' ')) {
                            e.preventDefault();
                            const index = Array.from(optionsContainer.children).indexOf(optionCard);
                            this.selectOption(index, optionCard);
                        }
                    });
                    birthDateInput.addEventListener('change', () => this.validateBirthDate());
                } catch (error) {
                    console.error('Failed to setup event listeners:', error);
                }
            },

            validateBirthDate: function() {
                try {
                    const birthDateInput = document.getElementById('birthDateInput');
                    const birthDateHelp = document.getElementById('birthDateHelp');
                    if (!birthDateInput || !birthDateHelp) return false;

                    const date = new Date(birthDateInput.value);
                    const today = new Date();
                    if (!birthDateInput.value || isNaN(date) || date > today) {
                        birthDateHelp.classList.remove('al-nada-hidden');
                        birthDateInput.setCustomValidity('Please enter a valid past date');
                        return false;
                    } else {
                        birthDateHelp.classList.add('al-nada-hidden');
                        birthDateInput.setCustomValidity('');
                        return true;
                    }
                } catch (error) {
                    console.error('Birth date validation failed:', error);
                    return false;
                }
            },

            displayQuestion: function() {
                try {
                    console.log(`Displaying question ${this.currentQuestion + 1}...`);
                    const question = this.questions[this.currentQuestion];
                    const questionText = document.getElementById('questionText');
                    const optionsContainer = document.getElementById('optionsContainer');
                    const currentQSpan = document.getElementById('currentQ');
                    const totalQSpan = document.getElementById('totalQ');
                    const progressFill = document.getElementById('progressFill');

                    if (!questionText || !optionsContainer || !currentQSpan || !totalQSpan || !progressFill) {
                        throw new Error('Question display elements not found');
                    }

                    questionText.textContent = question[this.currentLang];
                    currentQSpan.textContent = this.currentQuestion + 1;
                    totalQSpan.textContent = this.questions.length;
                    const progressPercent = ((this.currentQuestion + 1) / this.questions.length) * 100;
                    progressFill.style.width = `${progressPercent}%`;

                    while (optionsContainer.firstChild) {
                        optionsContainer.removeChild(optionsContainer.firstChild);
                    }
                    question.options.forEach((option, index) => {
                        console.log(`Adding option: ${option[this.currentLang === 'en' ? 0 : 1]}`);
                        const optionCard = document.createElement('div');
                        optionCard.className = 'option-card';
                        optionCard.setAttribute('role', 'option');
                        optionCard.setAttribute('tabindex', '0');
                        optionCard.setAttribute('aria-selected', this.answers[this.currentQuestion] === index ? 'true' : 'false');
                        optionCard.innerHTML = `<div class="option-text">${option[this.currentLang === 'en' ? 0 : 1]}</div>`;
                        if (this.answers[this.currentQuestion] === index) {
                            optionCard.classList.add('selected');
                        }
                        optionsContainer.appendChild(optionCard);
                    });

                    this.updateNavigationButtons();
                } catch (error) {
                    console.error('Failed to display question:', error);
                }
            },

            selectOption: function(optionIndex, optionElement) {
                try {
                    const startTime = this.responseTimes[this.currentQuestion]?.start || Date.now();
                    const endTime = Date.now();
                    this.responseTimes[this.currentQuestion] = { start: startTime, duration: endTime - startTime };

                    document.querySelectorAll('.option-card').forEach(card => {
                        card.classList.remove('selected');
                        card.setAttribute('aria-selected', 'false');
                    });

                    optionElement.classList.add('selected');
                    optionElement.setAttribute('aria-selected', 'true');
                    this.answers[this.currentQuestion] = optionIndex;

                    this.updateNavigationButtons();
                } catch (error) {
                    console.error('Option selection failed:', error);
                }
            },

            updateNavigationButtons: function() {
                try {
                    const prevButton = document.getElementById('prevButton');
                    const nextButton = document.getElementById('nextButton');
                    const generateButton = document.getElementById('generateButton');

                    if (!prevButton || !nextButton || !generateButton) return;

                    prevButton.disabled = this.currentQuestion === 0;
                    const hasAnswer = this.answers[this.currentQuestion] !== undefined;
                    nextButton.disabled = !hasAnswer;

                    if (this.currentQuestion === this.questions.length - 1) {
                        nextButton.classList.add('al-nada-hidden');
                        generateButton.classList.remove('al-nada-hidden');
                        generateButton.disabled = !hasAnswer || this.answers.filter(a => a !== undefined).length < TOTAL_QUESTIONS || !this.validateBirthDate();
                    } else {
                        nextButton.classList.remove('al-nada-hidden');
                        generateButton.classList.add('al-nada-hidden');
                    }
                } catch (error) {
                    console.error('Navigation buttons update failed:', error);
                }
            },

            previousQuestion: function() {
                if (this.currentQuestion > 0) {
                    this.currentQuestion--;
                    this.displayQuestion();
                }
            },

            nextQuestion: function() {
                if (this.currentQuestion < this.questions.length - 1 && this.answers[this.currentQuestion] !== undefined) {
                    this.currentQuestion++;
                    this.displayQuestion();
                }
            },

            toggleLanguage: function() {
                try {
                    this.currentLang = this.currentLang === 'en' ? 'ar' : 'en';
                    document.documentElement.lang = this.currentLang;
                    const langToggle = document.getElementById('langToggle');
                    const subtitle = document.getElementById('subtitle');
                    const select = document.getElementById('ingredientPref');

                    if (!langToggle || !subtitle || !select) return;

                    langToggle.textContent = this.currentLang === 'en' ? 'AR' : 'EN';
                    langToggle.setAttribute('aria-label', `Switch to ${this.currentLang === 'en' ? 'Arabic' : 'English'}`);
                    subtitle.textContent = this.currentLang === 'en' ? 'اكتشف عطرك الشخصي' : 'Discover Your Signature Fragrance';

                    document.querySelectorAll('.intro-text').forEach(p => {
                        p.style.display = p.getAttribute('data-lang') === this.currentLang ? 'block' : 'none';
                    });

                    const options = [
                        { en: 'Natural & Synthetic', ar: 'طبيعي وصناعي', value: 'both' },
                        { en: 'Natural Only', ar: 'طبيعي فقط', value: 'natural' },
                        { en: 'Synthetic Only', ar: 'صناعي فقط', value: 'synthetic' }
                    ];
                    select.innerHTML = options.map(opt => `<option value="${opt.value}">${opt[this.currentLang]}</option>`).join('');

                    this.displayQuestion();
                } catch (error) {
                    console.error('Language toggle failed:', error);
                }
            },

            calculateEnhancedScore: function() {
                if (this.cachedScore) return this.cachedScore;

                this.initScore();
                this.answers.forEach((answerIndex, questionIndex) => {
                    if (answerIndex !== undefined) {
                        const question = this.questions[questionIndex];
                        const selectedOption = question.options[answerIndex];
                        const traits = selectedOption[2];
                        const weight = this.questionWeights[questionIndex] || 1.0;

                        if (traits[0]) this.score.style[traits[0]] += weight;
                        if (traits[1]) this.score.emotion[traits[1]] += weight;
                        if (traits[2]) this.score.family[traits[2]] += weight;
                        if (traits[3]) this.score.memory[traits[3]] += weight;
                    }
                });

                this.cachedScore = this.calculateConfidence();
                return this.cachedScore;
            },

            calculateConfidence: function() {
                const totalResponses = this.answers.filter(a => a !== undefined).length;
                let consistencyScore = 0;
                let coherenceScore = 0;
                let responseTimeScore = 0;

                for (let category in this.score) {
                    const scores = Object.values(this.score[category]);
                    const maxScore = Math.max(...scores);
                    const secondMaxScore = scores.sort((a, b) => b - a)[1] || 0;
                    if (maxScore > 0) {
                        consistencyScore += (maxScore - secondMaxScore) / maxScore;
                    }
                }
                consistencyScore /= Object.keys(this.score).length;

                const style = this.getTopCategories().style.primary;
                const family = this.getTopCategories().family.primary;
                const validPairs = {
                    elegant: ['oriental', 'floral'],
                    bold: ['spicy', 'citrus'],
                    mysterious: ['woody', 'oriental'],
                    refreshing: ['citrus', 'aquatic'],
                    playful: ['citrus', 'gourmand'],
                    sensual: ['floral', 'oriental'],
                    exotic: ['spicy', 'oriental'],
                    minimalist: ['aquatic', 'woody'],
                    adventurous: ['spicy', 'woody'],
                    classic: ['floral', 'oriental'],
                    bohemian: ['floral', 'gourmand'],
                    modern: ['citrus', 'aquatic']
                };
                coherenceScore = validPairs[style].includes(family) ? 1 : 0.5;

                const durations = this.responseTimes.map(t => t?.duration || 0).filter(d => d > 0);
                const avgDuration = durations.length ? durations.reduce((a, b) => a + b, 0) / durations.length : 0;
                responseTimeScore = durations.every(d => d >= 1000 && d <= 30000) ? 1 : 0.8;

                const baseConfidence = consistencyScore * 0.6 + coherenceScore * 0.2 + responseTimeScore * 0.2;
                const responseCompleteness = (totalResponses / this.questions.length);
                return Math.min(99, (baseConfidence * 0.8 + responseCompleteness * 0.2) * 100);
            },

            getTopCategories: function() {
                let topCategories = {};
                for (let categoryType in this.score) {
                    let sorted = Object.entries(this.score[categoryType]).sort((a, b) => b[1] - a[1]);
                    topCategories[categoryType] = {
                        primary: sorted[0][0],
                        secondary: sorted[1] ? sorted[1][0] : sorted[0][0],
                        tertiary: sorted[2] ? sorted[2][0] : sorted[1] ? sorted[1][0] : sorted[0][0]
                    };
                }
                return topCategories;
            },

            getSeasonalInfluence: function() {
                try {
                    const birthDate = document.getElementById('birthDateInput').value;
                    if (!birthDate) return null;

                    const date = new Date(birthDate);
                    const today = new Date();
                    if (isNaN(date) || date > today) return null;

                    const month = date.getMonth();
                    if (month >= 2 && month <= 4) return 'spring';
                    if (month >= 5 && month <= 7) return 'summer';
                    if (month >= 8 && month <= 10) return 'autumn';
                    return 'winter';
                } catch (error) {
                    console.error('Seasonal influence calculation failed:', error);
                    return null;
                }
            },

            getPerfumeBlend: function(dominantFamily, topCategories, ingredientPref) {
                try {
                    console.log(`Generating perfume blend for family: ${dominantFamily}, pref: ${ingredientPref}`);
                    let blend = { top: [], heart: [], base: [] };
                    const familyNotes = this.pyramidNotes[dominantFamily];

                    if (!familyNotes || !familyNotes[0] || !familyNotes[1] || !familyNotes[2]) {
                        throw new Error('Invalid family notes structure');
                    }

                    const filterNotes = (notesArray) => {
                        if (ingredientPref === 'natural') {
                            return notesArray.filter(note => note.endsWith('(N)'));
                        } else if (ingredientPref === 'synthetic') {
                            return notesArray.filter(note => note.endsWith('(B)') || note.endsWith('(S)'));
                        }
                        return notesArray;
                    };

                    const selectNotes = (notes, count, layer) => {
                        let availableNotes = filterNotes(notes);
                        if (availableNotes.length < count) {
                            console.warn(`Insufficient notes for ${layer}, available: ${availableNotes.length}`);
                            availableNotes = availableNotes.concat(notes);
                        }
                        let selectedNotes = [];
                        const primaryStyle = topCategories.style.primary;
                        const primaryEmotion = topCategories.emotion.primary;
                        const secondaryStyle = topCategories.style.secondary;
                        const secondaryEmotion = topCategories.emotion.secondary;

                        const traitNotes = [
                            ...(this.traitToNoteMap[primaryStyle] || []),
                            ...(this.traitToNoteMap[primaryEmotion] || []),
                            ...(this.traitToNoteMap[secondaryStyle] || []),
                            ...(this.traitToNoteMap[secondaryEmotion] || [])
                        ].filter(note => availableNotes.includes(note));

                        for (let i = traitNotes.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [traitNotes[i], traitNotes[j]] = [traitNotes[j], traitNotes[i]];
                        }

                        for (let i = 0; i < count && traitNotes.length > 0; i++) {
                            selectedNotes.push(traitNotes.shift());
                            availableNotes = availableNotes.filter(note => !selectedNotes.includes(note));
                        }

                        while (selectedNotes.length < count && availableNotes.length > 0) {
                            const noteIndex = Math.floor(Math.random() * availableNotes.length);
                            selectedNotes.push(availableNotes[noteIndex]);
                            availableNotes.splice(noteIndex, 1);
                        }

                        if (selectedNotes.length < count) {
                            console.warn(`Only selected ${selectedNotes.length} notes for ${layer}`);
                        }
                        return selectedNotes;
                    };

                    blend.top = selectNotes(familyNotes[0], 3, 'top');
                    blend.heart = selectNotes(familyNotes[1], 3, 'heart');
                    blend.base = selectNotes(familyNotes[2], 3, 'base');

                    console.log('Generated blend:', blend);
                    return blend;
                } catch (error) {
                    console.error('Failed to generate perfume blend:', error);
                    return { top: [], heart: [], base: [] };
                }
            },

            generateResult: function() {
                try {
                    if (this.generateClicked) return;
                    this.generateClicked = true;
                    const generateButton = document.getElementById('generateButton');
                    if (generateButton) generateButton.disabled = true;

                    if (this.answers.filter(a => a !== undefined).length < TOTAL_QUESTIONS || !this.validateBirthDate()) {
                        alert('Please answer all questions and provide a valid birth date.');
                        this.generateClicked = false;
                        if (generateButton) generateButton.disabled = false;
                        return;
                    }

                    const emotion0 = this.questions[0].options[this.answers[0]]?.[2][1];
                    const emotion10 = this.questions[10].options[this.answers[10]]?.[2][1];
                    if (emotion0 !== emotion10) {
                        if (!confirm('Your answers to similar questions differ. Proceed or review?')) {
                            this.generateClicked = false;
                            if (generateButton) generateButton.disabled = false;
                            return;
                        }
                    }

                    const uniqueAnswers = new Set(this.answers);
                    if (uniqueAnswers.size <= 3) {
                        if (!confirm('Your answers seem repetitive. Confirm intentional selections?')) {
                            this.generateClicked = false;
                            if (generateButton) generateButton.disabled = false;
                            return;
                        }
                    }

                    const topCategories = this.getTopCategories();
                    if (!confirm(`Your profile suggests a ${topCategories.style.primary} style and ${topCategories.emotion.primary} emotion. Generate results?`)) {
                        this.generateClicked = false;
                        if (generateButton) generateButton.disabled = false;
                        return;
                    }

                    const resultDiv = document.getElementById('result');
                    if (!resultDiv) return;

                    document.querySelectorAll('.intro-text').forEach(p => p.style.display = 'none');

                    const answerSet = {
                        answers: this.answers,
                        birthDate: document.getElementById('birthDateInput').value,
                        ingredientPref: document.getElementById('ingredientPref').value
                    };
                    const answerKey = simpleHash(JSON.stringify(answerSet));

                    if (this.resultCache[answerKey]) {
                        console.log(`Loading cached result for answerKey: ${answerKey}`);
                        resultDiv.innerHTML = this.resultCache[answerKey];
                        document.querySelector('.quiz-container').classList.add('al-nada-hidden');
                        resultDiv.classList.remove('al-nada-hidden');
                        this.generateClicked = false;
                        if (generateButton) generateButton.disabled = false;
                        return;
                    }

                    resultDiv.innerHTML = '<p class="loading">Generating your fragrance profile...</p>';
                    document.querySelector('.quiz-container').classList.add('al-nada-hidden');
                    resultDiv.classList.remove('al-nada-hidden');

                    setTimeout(() => {
                        const confidence = this.calculateEnhancedScore();
                        const dominantFamily = Object.entries(this.score.family).sort((a, b) => b[1] - a[1])[0][0];
                        const ingredientPref = document.getElementById('ingredientPref').value;
                        const season = this.getSeasonalInfluence();
                        const blend = this.getPerfumeBlend(dominantFamily, topCategories, ingredientPref);
                        const t = translations[this.currentLang];

                        let resultHtml = `
                            <div class="result-title">${t.resultTitle}</div>
                            <div class="personality-analysis">
                                <div class="analysis-title">${t.personalityAnalysis}</div>
                                <p><strong>${t.styleLabel}:</strong> ${t.styles[topCategories.style.primary]} (${confidence.toFixed(1)}% confidence)</p>
                                <p><strong>${t.emotionLabel}:</strong> ${t.emotions[topCategories.emotion.primary]} with ${t.emotions[topCategories.emotion.secondary]} undertones</p>
                                <p><strong>${t.fragranceFamilyLabel}:</strong> ${t.families[dominantFamily]}</p>
                                <p><strong>${t.memoryLabel}:</strong> ${t.memories[topCategories.memory.primary]}</p>
                            </div>
                            <div class="analysis-title">${t.fragranceComposition}</div>
                            <div class="fragrance-composition">
                                <div class="note-category">
                                    <div class="note-title">${t.topNotes}</div>
                                    <div class="note-list">${blend.top.length > 0 ? blend.top.join('<br>') : 'No top notes available'}</div>
                                </div>
                                <div class="note-category">
                                    <div class="note-title">${t.heartNotes}</div>
                                    <div class="note-list">${blend.heart.length > 0 ? blend.heart.join('<br>') : 'No heart notes available'}</div>
                                </div>
                                <div class="note-category">
                                    <div class="note-title">${t.baseNotes}</div>
                                    <div class="note-list">${blend.base.length > 0 ? blend.base.join('<br>') : 'No base notes available'}</div>
                                </div>
                            </div>`;

                        if (season) {
                            const seasonalData = this.seasonalInfluence[season];
                            resultHtml += `<p><strong>${t.seasonalHarmony}:</strong> ${t.seasonalText.replace('{{season}}', t.seasons[season]).replace('{{character}}', t.seasonalCharacters[seasonalData.character]).replace('{{intensity}}', t.seasonalIntensities[seasonalData.intensity])}</p>`;
                        }

                        resultHtml += `
                            <div class="fragrance-story">
                                <div class="story-title">${t.fragranceStory}</div>
                                <p>${t.storyText.replace('{{style}}', t.styles[topCategories.style.primary]).replace('{{emotion}}', t.emotions[topCategories.emotion.primary]).replace('{{family}}', t.families[dominantFamily]).replace('{{description}}', t.familyDescriptions[this.getFamilyDescription(dominantFamily)])}</p>
                                <p class="disclaimer">${t.disclaimer}</p>
                            </div>
                        `;

                        resultDiv.innerHTML = resultHtml;
                        this.resultCache[answerKey] = resultHtml;
                        console.log(`Cached result for answerKey: ${answerKey} in session: ${this.sessionId}`);
                    }, 1000);
                } catch (error) {
                    console.error('Result generation failed:', error);
                    alert('An error occurred while generating results. Please try again.');
                    this.generateClicked = false;
                    if (generateButton) generateButton.disabled = false;
                }
            },

            getFamilyDescription: function(family) {
                const descriptions = {
                    oriental: "warm, exotic, and mysterious",
                    citrus: "fresh, energetic, and uplifting",
                    woody: "grounded, sophisticated, and natural",
                    floral: "romantic, elegant, and feminine",
                    spicy: "bold, passionate, and adventurous",
                    gourmand: "comforting, indulgent, and warm",
                    aquatic: "fresh, clean, and serene"
                };
                return descriptions[family] || "unique and distinctive";
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing quiz...');
            PerfumeGenerator.init();
        });
    </script>
</body>
</html>
