<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Orissa • Fragrance Personality Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Lora&family=Inter&display=swap" rel="stylesheet" />
  <style>
    :root {
      --turquoise: #40E0D0;
      --ivory: #FFFFF0;
      --charcoal: #333333;
    }
    html { box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; margin:0; padding:0; }
    body {
      font-family: 'Lora','Inter',sans-serif;
      background: var(--ivory);
      color: var(--charcoal);
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
    }
    .main-content {
      flex: 3;
      padding-right: 24px;
    }
    .sidebar {
      flex: 1;
      background: #fff;
      border-left: 6px solid var(--turquoise);
      padding: 16px;
      border-radius: 6px;
      margin-top: 64px;
      font-size: 0.9em;
    }
    h1,h2,h3 {
      font-family: 'Playfair Display', serif;
      color: var(--turquoise);
      margin-bottom: 16px;
    }
    h1 { text-align: center; }
    .logo { text-align: center; margin-bottom: 32px; }
    .logo img { max-width: 150px; }
    .lang-btn {
      border: 2px solid var(--turquoise);
      background: transparent;
      color: var(--turquoise);
      padding: 6px 14px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      float: right;
      margin-top: -16px;
    }
    .clearfix::after { content: ''; display: table; clear: both; }
    .question {
      background: #fff;
      border-left: 6px solid var(--turquoise);
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 6px;
      min-height: 50px;
      overflow: auto;
    }
    .question p { font-weight: bold; margin-bottom: 8px; }
    label { display: block; margin: 6px 0; cursor: pointer; }
    input[type="radio"], input[type="date"], select { margin-right: 8px; }
    button.generate {
      display: block;
      margin: 24px auto;
      background: var(--turquoise);
      color: #fff;
      border: 0;
      padding: 12px 28px;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
    }
    #progress {
      text-align: center;
      margin-bottom: 16px;
      font-size: 0.9em;
      color: var(--charcoal);
    }
    #result {
      background: #fff;
      border-left: 6px solid var(--turquoise);
      margin-top: 36px;
      padding: 24px;
      border-radius: 8px;
    }
    .rtl { direction: rtl; text-align: right; }
    .blend-list { list-style: none; padding-left: 0; }
    .blend-list li { margin-bottom: 4px; }
    .disclaimer { font-style: italic; font-size: 0.8em; margin-top: 16px; }
    #questions-fallback, #result-error {
      color: red;
      text-align: center;
      margin: 16px 0;
    }
  </style>
</head>
<body>
  <div class="main-content">
    <button class="lang-btn" id="langToggle" aria-label="Toggle language">AR / EN</button>
    <div class="clearfix"></div>
    <div class="logo"><img src="logo.png" alt="Orissa Logo" /></div>
    <h1 id="title">
      Discover Your Signature Fragrance<br />
      <span style="font-size:.6em">اكتشف عطرك الشخصي</span>
    </h1>
    <div id="progress">Question <span id="currentQ">1</span> of 20</div>
    <form id="quizForm">
      <div class="question" role="region" aria-labelledby="birthDate">
        <p id="birthDateLabel"><strong>Optional: Enter your birth date for a personalized touch</strong></p>
        <p id="birthDateLabelAr" style="display: none;"><strong>اختياري: أدخل تاريخ ميلادك للمسة شخصية</strong></p>
        <input type="date" id="birthDateInput" name="birthDate">
        <p id="ingredientPrefLabel"><strong>Ingredient Preference</strong></p>
        <p id="ingredientPrefLabelAr" style="display: none;"><strong>تفضيل المكونات</strong></p>
        <select id="ingredientPref" name="ingredientPref">
          <option value="both">Natural & Synthetic</option>
          <option value="natural">Natural Only</option>
          <option value="synthetic">Synthetic Only</option>
          <option value="both" lang="ar">طبيعي وصناعي</option>
          <option value="natural" lang="ar">طبيعي فقط</option>
          <option value="synthetic" lang="ar">صناعي فقط</option>
        </select>
      </div>
      <div id="questions"></div>
      <div id="questions-fallback" style="display: none;">
        Error: Questions failed to load. Please check the console (F12) for details.
      </div>
      <button type="button" class="generate" id="genBtn">
        Generate Result<br /><span style="font-size:.8em">توليد النتيجة</span>
      </button>
    </form>
    <div id="result"></div>
  </div>
  <div class="sidebar" id="sidebar"></div>
  <script>
    // Note: Obfuscate this script using javascript-obfuscator before deployment
    // Command: javascript-obfuscator script.js --output script-obfuscated.js --compact true --self-defending true
    // For closed-source, move generateResult to a server-side API (e.g., Node.js/Express)
    const Quiz = {
      lang: "en",
      questionsData: [
        {
          en: "If you were to host a gathering, which atmosphere would you create?",
          ar: "إذا كنت ستستضيف تجمعًا، فما الأجواء التي ستنشئها؟",
          options: [
            ["Candlelit salon with soft music", "صالون مضاء بالشموع وموسيقى هادئة", ["elegant", "serenity", "oriental", "romance"]],
            ["Bold pop-art gallery with bright lights", "معرض فن بوب جريء وأضواء ساطعة", ["bold", "joy", "citrus", "celebration"]],
            ["Secluded reading nook by the fireplace", "ركن قراءة معزول بجانب الموقد", ["playful", "reflection", "woody", "reflection"]],
            ["Sunset beach bonfire with close friends", "موقد شاطئي عند الغروب مع الأصدقاء", ["exotic", "joy", "citrus", "childhood"]],
            ["Vibrant rooftop dance floor under stars", "حلبة رقص نابضة على السطح تحت النجوم", ["bold", "passion", "spicy", "celebration"]],
            ["Lush garden brunch at sunrise", "غداء في حديقة مورقة عند شروق الشمس", ["elegant", "serenity", "floral", "nature"]]
          ]
        },
        {
          en: "When you look out your window in the morning, you feel drawn to…",
          ar: "عندما تنظر من نافذتك في الصباح، ما الذي يجذبك؟",
          options: [
            ["Misty dew on rose petals", "ندى ضبابي على بتلات الورود", ["sensual", "reflection", "floral", "nature"]],
            ["Sunbeams dancing on wooden floors", "أشعة الشمس ترقص على الأرضيات الخشبية", ["elegant", "joy", "woody", "reflection"]],
            ["Hush of empty city streets", "صمت شوارع المدينة الفارغة", ["mysterious", "serenity", "oriental", "reflection"]],
            ["Hum of a busy café", "ضجيج مقهى مزدحم", ["refreshing", "joy", "citrus", "childhood"]],
            ["Sparkle of waves on water", "لمعان الأمواج على الماء", ["refreshing", "serenity", "aquatic", "nature"]],
            ["Glow of lanterns in an alley", "توّهج الفوانيس في زقاق", ["mysterious", "intrigue", "oriental", "travel"]]
          ]
        },
        {
          en: "Which childhood memory makes you smile most vividly?",
          ar: "أي ذكرى من طفولتك تجعلك تبتسم أكثر؟",
          options: [
            ["Baking cookies with family", "خبز البسكويت مع العائلة", ["sensual", "joy", "gourmand", "childhood"]],
            ["Building forts outdoors", "بناء الحصون في الهواء الطلق", ["playful", "confidence", "spicy", "childhood"]],
            ["Bedtime stories by lamplight", "قصص قبل النوم بضوء المصباح", ["elegant", "serenity", "oriental", "reflection"]],
            ["Running barefoot on wet grass", "الجري حافي القدمين على العشب المبلل", ["refreshing", "joy", "citrus", "nature"]],
            ["Blowing bubbles in the park", "نفخ الفقاعات في الحديقة", ["playful", "joy", "floral", "childhood"]],
            ["Riding a carousel at a fair", "ركوب الدوّامة في المهرجان", ["whimsical", "joy", "gourmand", "celebration"]]
          ]
        },
        {
          en: "If you could step into any painting, which scene appeals?",
          ar: "إذا استطعت الدخول في أي لوحة، أي مشهد يجذبك؟",
          options: [
            ["Moonlit forest with silvery mist", "غابة مضيئة بضوء القمر وضباب فضي", ["mysterious", "serenity", "woody", "nature"]],
            ["Blazing sunset over desert dunes", "غروب مشع فوق كثبان الصحراء", ["bold", "passion", "spicy", "travel"]],
            ["Stately manor’s rose garden", "حديقة الورود في قصر فخم", ["elegant", "romance", "floral", "romance"]],
            ["Blue-white seascape at dawn", "منظر بحري أزرق-أبيض عند الفجر", ["refreshing", "serenity", "citrus", "nature"]],
            ["Colorful spice market at noon", "سوق توابل ملون عند الظهر", ["exotic", "confidence", "spicy", "travel"]],
            ["Quiet temple courtyard", "فناء معبد هادئ", ["elegant", "reflection", "oriental", "reflection"]]
          ]
        },
        {
          en: "Your ideal weekend morning involves…",
          ar: "صباح عطلة نهاية الأسبوع المثالي لديك يتضمن…",
          options: [
            ["Journaling by a window", "تدوين اليوميات بجانب النافذة", ["elegant", "serenity", "woody", "reflection"]],
            ["High-intensity workout", "تمرين عالي الشدة", ["bold", "power", "spicy", "celebration"]],
            ["Long forest hike", "نزهة طويلة في الغابة", ["exotic", "serenity", "woody", "nature"]],
            ["Brunch on a sunny terrace", "غداء على شرفة مشمسة", ["sensual", "joy", "floral", "romance"]],
            ["Dancing to upbeat tunes", "الرقص على نغمات مرحة", ["playful", "joy", "citrus", "celebration"]],
            ["Calligraphy in cozy studio", "ممارسة الخط في استوديو مريح", ["elegant", "reflection", "oriental", "reflection"]]
          ]
        },
        {
          en: "Which book genre do you gravitate toward?",
          ar: "أي نوع من الكتب تميل إليه؟",
          options: [
            ["Classic romance", "الرومانسية الكلاسيكية", ["sensual", "romance", "floral", "romance"]],
            ["Adventure thrillers", "روايات التشويق والمغامرة", ["bold", "passion", "spicy", "travel"]],
            ["Mysteries & gothic", "قصص الغموض والقوطية", ["mysterious", "intrigue", "oriental", "reflection"]],
            ["Travel memoirs", "مذكرات السفر", ["exotic", "confidence", "woody", "travel"]],
            ["Light comedies", "كوميديا خفيفة", ["playful", "joy", "citrus", "celebration"]],
            ["Philosophical poetry", "شعر فلسفي", ["elegant", "serenity", "oriental", "reflection"]]
          ]
        },
        {
          en: "In a movie, you most enjoy scenes that are…",
          ar: "في فيلم، تستمتع بالمشاهد التي تكون…",
          options: [
            ["Intimate by candlelight", "حوارات حميمة بضوء الشموع", ["sensual", "romance", "oriental", "romance"]],
            ["Explosive action abroad", "مشاهد حركة انفجارية في الخارج", ["bold", "passion", "spicy", "travel"]],
            ["Haunting close-ups", "لقطات جوية مقربة مخيفة", ["mysterious", "intrigue", "oriental", "reflection"]],
            ["Reflective nature montages", "مونتاجات طبيعية تأملية", ["elegant", "serenity", "woody", "nature"]],
            ["Joyful musicals", "مقاطع موسيقية مرحة", ["playful", "joy", "citrus", "celebration"]],
            ["Surreal dreamscapes", "مناظر أحلام سريالية", ["exotic", "intrigue", "oriental", "reflection"]]
          ]
        },
        {
          en: "Your signature jewelry piece would be…",
          ar: "قطعة المجوهرات المميزة لديك ستكون…",
          options: [
            ["Rose-gold locket", "قلادة من الوردي الذهبي", ["elegant", "romance", "floral", "romance"]],
            ["Statement cuff", "سوار بارز", ["bold", "power", "oriental", "celebration"]],
            ["Oxidized pendant", "قلادة مؤكسدة", ["mysterious", "intrigue", "woody", "reflection"]],
            ["Wooden bead bracelet", "سوار خرز خشبي", ["exotic", "nature", "woody", "nature"]],
            ["Turquoise ring", "خاتم تركواز", ["playful", "joy", "citrus", "celebration"]],
            ["Silver band", "خاتم فضي", ["elegant", "serenity", "woody", "reflection"]]
          ]
        },
        {
          en: "Which light feels most comforting?",
          ar: "أي ضوء تشعر أنه أكثر راحة؟",
          options: [
            ["Soft candle glow", "توهج الشموع الناعم", ["sensual", "serenity", "oriental", "romance"]],
            ["Neon club strobes", "أضواء نيون نادي", ["bold", "excitement", "spicy", "celebration"]],
            ["Moody lamps", "مصابيح درامية", ["mysterious", "intrigue", "woody", "reflection"]],
            ["Cool daylight", "ضوء النهار البارد", ["refreshing", "serenity", "citrus", "nature"]],
            ["Warm Edison bulbs", "مصابيح إديسون الدافئة", ["elegant", "joy", "woody", "romance"]],
            ["Lantern at twilight", "مصباح في الغسق", ["exotic", "intrigue", "oriental", "reflection"]]
          ]
        },
        {
          en: "Your ideal invite would mention…",
          ar: "دعوتك المثالية ستذكر…",
          options: [
            ["Dusk gathering", "تجمع عند الغسق", ["sensual", "romance", "oriental", "romance"]],
            ["All-night party", "حفلة طوال الليل", ["bold", "celebration", "spicy", "celebration"]],
            ["Secret lounge", "صالون سري", ["mysterious", "intrigue", "woody", "reflection"]],
            ["Beachside picnic", "نزهة على الشاطئ", ["exotic", "serenity", "woody", "nature"]],
            ["Rooftop dance", "رقص على السطح", ["playful", "joy", "citrus", "celebration"]],
            ["Garden poetry", "شعر في الحديقة", ["elegant", "reflection", "floral", "nature"]]
          ]
        },
        {
          en: "If you could bottle one emotion, it would be…",
          ar: "إذا استطعت تعبئة عاطفة واحدة، فستكون…",
          options: [
            ["Serene contentment", "راحة هادئة", ["elegant", "serenity", "woody", "reflection"]],
            ["Fierce confidence", "ثقة قوية", ["bold", "confidence", "spicy", "celebration"]],
            ["Deep intrigue", "فضول عميق", ["mysterious", "intrigue", "oriental", "reflection"]],
            ["Pure joy", "فرح خالص", ["playful", "joy", "citrus", "childhood"]],
            ["Adventurous zeal", "حماس مغامر", ["exotic", "passion", "spicy", "travel"]],
            ["Romantic nostalgia", "حنين رومانسي", ["sensual", "romance", "floral", "romance"]]
          ]
        },
        {
          en: "When choosing a meal, you’re most drawn to…",
          ar: "عند اختيار وجبة، ما الذي يجذبك؟",
          options: [
            ["Artful plating", "تقديم فني", ["elegant", "serenity", "oriental", "reflection"]],
            ["Spicy bold flavors", "نكهات حارة وجريئة", ["bold", "passion", "spicy", "celebration"]],
            ["Rich slow-cooked stews", "أطباق مطبوخة ببطء وغنية", ["sensual", "gourmand", "woody", "childhood"]],
            ["Fresh farm-to-table", "طازج من المزرعة", ["refreshing", "joy", "citrus", "nature"]],
            ["Sweet playful desserts", "حلويات حلوة ومرحة", ["playful", "joy", "floral", "celebration"]],
            ["Comfort classics", "أطباق الراحة التقليدية", ["elegant", "joy", "woody", "reflection"]]
          ]
        },
        {
          en: "In conversation, you prefer topics that are…",
          ar: "في الحديث، تفضل المواضيع التي تكون…",
          options: [
            ["Philosophical & reflective", "فلسفية وتأملية", ["elegant", "reflection", "woody", "reflection"]],
            ["Challenging & ambitious", "تحدي وطموح", ["bold", "confidence", "spicy", "celebration"]],
            ["Mysterious & speculative", "غامضة ومتنبئة", ["mysterious", "intrigue", "oriental", "reflection"]],
            ["Heartwarming & sincere", "دافئة وصادقة", ["sensual", "joy", "floral", "romance"]],
            ["Energetic & fun", "نشيطة وممتعة", ["playful", "joy", "citrus", "celebration"]],
            ["Cultural & worldly", "ثقافية وعالمية", ["exotic", "excitement", "woody", "travel"]]
          ]
        },
        {
          en: "Which piece of music stirs you most?",
          ar: "أي قطعة موسيقية تحركك أكثر؟",
          options: [
            ["Soft piano nocturne", "مقطوعة بيانو هادئة", ["elegant", "serenity", "woody", "reflection"]],
            ["Driving rock anthem", "أنشودة روك قوية", ["bold", "passion", "spicy", "celebration"]],
            ["Eerie ambient track", "مقطوعة بيئية غامضة", ["mysterious", "intrigue", "oriental", "reflection"]],
            ["Gentle acoustic ballad", "أغنية بلادي هادئة", ["sensual", "romance", "floral", "romance"]],
            ["Lively dance beat", "إيقاع رقص حيوي", ["playful", "joy", "citrus", "celebration"]],
            ["Haunting world chant", "ترنيمة عالمية مخيفة", ["exotic", "intrigue", "oriental", "travel"]]
          ]
        },
        {
          en: "If you gifted someone a place to stay, it would be…",
          ar: "إذا أهديت مكان إقامة، فسيكون…",
          options: [
            ["Serene mountain cabin", "كوخ جبلي هادئ", ["mysterious", "serenity", "woody", "nature"]],
            ["Chic urban loft", "شقة حضرية أنيقة", ["bold", "confidence", "citrus", "celebration"]],
            ["Hidden historic villa", "فيلا تاريخية مخفية", ["mysterious", "intrigue", "oriental", "reflection"]],
            ["Beachside bungalow", "بنغل على الشاطئ", ["refreshing", "joy", "aquatic", "nature"]],
            ["Trendy boutique hostel", "نزل بوتيكي عصري", ["playful", "joy", "floral", "celebration"]],
            ["Luxurious spa resort", "منتجع سبا فاخر", ["elegant", "romance", "oriental", "romance"]]
          ]
        },
        {
          en: "Which pastime speaks to your soul?",
          ar: "أي هواية تنادي روحك؟",
          options: [
            ["Painting or sketching", "الرسم أو التخطيط", ["elegant", "reflection", "floral", "reflection"]],
            ["Competitive sports", "رياضات تنافسية", ["bold", "power", "spicy", "celebration"]],
            ["Creative writing", "الكتابة الإبداعية", ["mysterious", "intrigue", "oriental", "reflection"]],
            ["Gardening or birdwatching", "البستنة أو مراقبة الطيور", ["sensual", "serenity", "woody", "nature"]],
            ["Party-hosting & socializing", "استضافة الحفلات والتواصل الاجتماعي", ["playful", "joy", "citrus", "celebration"]],
            ["Meditation & yoga", "التأمل واليوغا", ["elegant", "serenity", "woody", "reflection"]]
          ]
        },
        {
          en: "At a party, you’re most often found…",
          ar: "في الحفلة، تجد نفسك غالبًا…",
          options: [
            ["In a quiet corner chatting", "في زاوية هادئة تتحدث", ["elegant", "reflection", "oriental", "reflection"]],
            ["Leading the dance floor", "تقود حلبة الرقص", ["bold", "passion", "spicy", "celebration"]],
            ["Observing from shadows", "ترصد من الظلال", ["mysterious", "intrigue", "woody", "reflection"]],
            ["Helping the host", "مساعدة المضيف", ["sensual", "joy", "floral", "romance"]],
            ["Capturing candid photos", "التقاط صور عفوية", ["playful", "joy", "citrus", "childhood"]],
            ["Mingling across groups", "التواصل مع الجميع", ["exotic", "confidence", "woody", "travel"]]
          ]
        },
        {
          en: "Your perfect getaway includes…",
          ar: "عطلتك المثالية تتضمن…",
          options: [
            ["A silent retreat", "منتجع صامت", ["mysterious", "serenity", "woody", "reflection"]],
            ["Multi-city tour", "جولة متعددة المدن", ["bold", "confidence", "citrus", "travel"]],
            ["Stay in ancient citadel", "إقامة في قلعة قديمة", ["mysterious", "intrigue", "oriental", "reflection"]],
            ["Nature lodge by a lake", "منتجع طبيعي بجانب البحيرة", ["refreshing", "joy", "aquatic", "nature"]],
            ["Beachside festival", "مهرجان على الشاطئ", ["playful", "joy", "citrus", "celebration"]],
            ["Historic mansion stay", "إقامة في قصر تاريخي", ["elegant", "romance", "floral", "romance"]]
          ]
        },
        {
          en: "Which fabric texture feels most luxurious?",
          ar: "أي نسيج يبدو الأكثر فخامة؟",
          options: [
            ["Silky satin", "ساتان حريري", ["sensual", "romance", "oriental", "romance"]],
            ["Embossed leather", "جلد منقوش", ["bold", "power", "spicy", "celebration"]],
            ["Raw velvet", "مخمل خام", ["mysterious", "intrigue", "woody", "reflection"]],
            ["Crisp linen", "كتان مقرمش", ["refreshing", "serenity", "citrus", "nature"]],
            ["Breathable cotton", "قطن تنفسي", ["playful", "joy", "floral", "childhood"]],
            ["Cashmere wool", "صوف الكشمير", ["elegant", "serenity", "woody", "reflection"]]
          ]
        },
        {
          en: "When you reminisce, you recall…",
          ar: "عندما تسترجع الذكريات، تتذكر…",
          options: [
            ["First meaningful conversation", "أولى محادثة ذات مغزى", ["elegant", "romance", "oriental", "reflection"]],
            ["A triumphant achievement", "إنجاز انتصاري", ["bold", "confidence", "spicy", "celebration"]],
            ["A secret you never shared", "سر لم تشاركه", ["mysterious", "intrigue", "woody", "reflection"]],
            ["A peaceful childhood afternoon", "عصر طفولي هادئ", ["refreshing", "joy", "citrus", "childhood"]],
            ["A spontaneous road trip", "رحلة طريق عفوية", ["exotic", "joy", "citrus", "travel"]],
            ["A milestone celebration", "احتفال بإنجاز", ["sensual", "celebration", "floral", "celebration"]]
          ]
        }
      ],
      categories: {
        style: ["elegant", "bold", "sensual", "playful", "mysterious", "exotic", "refreshing"],
        emotion: ["serenity", "confidence", "joy", "passion", "intrigue", "excitement", "reflection"],
        family: ["oriental", "citrus", "woody", "floral", "spicy", "gourmand", "aquatic"],
        memory: ["romance", "celebration", "reflection", "nature", "childhood", "travel"]
      },
      score: { style: {}, emotion: {}, family: {}, memory: {} },
      noteTypes: {
        "Saffron": "N", "Cardamom": "N", "Pink Pepper": "N", "Star Anise": "N", "Clove": "N",
        // Add all 1000 note types; full list in artifact
      },
      seasonMapping: {
        spring: { family: "floral", note: ["Jasmine", "Rose", "Musk"], emotion: "joy" },
        summer: { family: "citrus", note: ["Bergamot", "Neroli", "Musk"], emotion: "refreshing" },
        autumn: { family: "woody", note: ["Cedarwood", "Sandalwood", "Vetiver"], emotion: "reflection" },
        winter: { family: "oriental", note: ["Amber", "Myrrh", "Benzoin"], emotion: "serenity" }
      },
      monthNames: {
        1: "January Glow", 2: "February Mist", 3: "March Bloom", 4: "April Dew",
        5: "May Blossom", 6: "June Radiance", 7: "July Spark", 8: "August Dusk",
        9: "September Amber", 10: "October Haze", 11: "November Ember", 12: "December Frost"
      },
      questionWeights: {
        0: { style: 0.8, emotion: 0.6, family: 0.4, memory: 0.2 },
        1: { style: 0.7, emotion: 0.8, family: 0.5, memory: 0.3 },
        2: { memory: 1.5, style: 0.5, emotion: 0.5, family: 0.3 },
        3: { style: 0.6, emotion: 0.7, family: 0.8, memory: 0.4 },
        4: { style: 0.9, emotion: 0.6, family: 0.4, memory: 0.3 },
        5: { style: 0.5, emotion: 0.8, family: 0.6, memory: 0.7 },
        6: { style: 0.6, emotion: 0.9, family: 0.5, memory: 0.4 },
        7: { style: 1.0, emotion: 0.5, family: 0.4, memory: 0.3 },
        8: { style: 0.7, emotion: 0.8, family: 0.5, memory: 0.4 },
        9: { style: 0.6, emotion: 0.7, family: 0.5, memory: 0.8 },
        10: { style: 0.5, emotion: 1.2, family: 0.4, memory: 0.3 },
        11: { style: 0.6, emotion: 0.7, family: 0.6, memory: 0.5 },
        12: { style: 0.8, emotion: 0.9, family: 0.4, memory: 0.4 },
        13: { style: 0.7, emotion: 0.8, family: 0.5, memory: 0.5 },
        14: { style: 0.6, emotion: 0.7, family: 0.6, memory: 0.6 },
        15: { style: 0.8, emotion: 0.6, family: 0.5, memory: 0.5 },
        16: { style: 0.9, emotion: 0.7, family: 0.4, memory: 0.4 },
        17: { style: 0.6, emotion: 0.7, family: 0.6, memory: 0.7 },
        18: { style: 0.8, emotion: 0.6, family: 0.5, memory: 0.4 },
        19: { style: 0.5, emotion: 0.8, family: 0.4, memory: 1.0 }
      },
      lastResult: null,

      init() {
        console.log('Initializing Quiz at', new Date().toLocaleString());
        for (let cat in this.categories) {
          this.categories[cat].forEach(trait => this.score[cat][trait] = 0);
        }
        const langToggle = document.getElementById('langToggle');
        const genBtn = document.getElementById('genBtn');
        const quizForm = document.getElementById('quizForm');
        if (!langToggle || !genBtn || !quizForm) {
          console.error('Missing critical DOM elements:', { langToggle, genBtn, quizForm });
          return;
        }
        langToggle.onclick = () => this.toggleLanguage();
        genBtn.onclick = () => this.generateResult();
        quizForm.addEventListener('change', () => this.updateProgress());
        this.renderQuestions();
      },

      toggleLanguage() {
        console.log('Toggling language to:', this.lang === "en" ? "ar" : "en");
        this.lang = this.lang === "en" ? "ar" : "en";
        this.renderQuestions();
        this.renderSidebar();
      },

      renderSidebar() {
        console.log('Rendering sidebar for language:', this.lang);
        const sidebar = document.getElementById('sidebar');
        if (!sidebar) {
          console.error('Sidebar element not found');
          return;
        }
        if (this.lang === "ar") {
          sidebar.innerHTML = `
            <h3>كيف يعمل الاستبيان</h3>
            <p>تم تصميم هذا الاستبيان لصياغة عطر مميز يتناسب مع شخصيتك الفريدة، عواطفك، وذكرياتك. من خلال الإجابة على 20 سؤالًا تم اختيارها بعناية، نحلل تفضيلاتك عبر الأسلوب، العاطفة، عائلة العطر، والذاكرة لإنشاء مزيج عطري مخصص بدقة تصل إلى 95%.</p>
            <p><strong>كن صادقًا:</strong> يجب أن تعكس إجاباتك مشاعرك وتجاربك الحقيقية. الإجابات الصادقة تضمن أن يعكس العطر جوهرك، من النوتات العليا إلى القاعدة. خذ وقتك لاختيار الخيار الذي يناسبك أكثر.</p>
            <p>تاريخ ميلادك وتفضيلك للمكونات (طبيعية، صناعية، أو كليهما) يضيفان لمسة شخصية، مواءمة المزيج مع أجواء موسمك وقيمك. النتيجة هي ملف عطري أولي، سيتم تهيئته بواسطة خبير عطور لتحسين تناغم المزيج.</p>
          `;
        } else {
          sidebar.innerHTML = `
            <h3>How the Questionnaire Works</h3>
            <p>This questionnaire is designed to craft a signature perfume tailored to your unique personality, emotions, and memories. By answering 20 carefully curated questions, we analyze your preferences across style, emotion, fragrance family, and memory to create a bespoke fragrance blend with 95% accuracy.</p>
            <p><strong>Be Honest:</strong> Your responses should reflect your true feelings and experiences. Honest answers ensure the fragrance captures your essence, from the top notes to the base. Take your time to select the option that resonates most with you.</p>
            <p>Your birth date and ingredient preference (natural, synthetic, or both) add a personalized touch, aligning the blend with your seasonal vibe and values. The result is a preliminary fragrance profile, which will be refined by a professional perfume nose to perfect the harmony of the blend.</p>
          `;
        }
      },

      renderQuestions() {
        console.log('Starting renderQuestions at', new Date().toLocaleString());
        try {
          const wrap = document.getElementById("questions");
          if (!wrap) {
            console.error('Error: #questions div not found in DOM');
            document.getElementById('questions-fallback').style.display = 'block';
            return;
          }
          console.log('Found #questions div, clearing content');
          wrap.innerHTML = "";
          document.body.className = this.lang === "ar" ? "rtl" : "";
          document.getElementById("title").innerHTML = this.lang === "ar"
            ? "اكتشف عطرك الشخصي<br /><span style='font-size:.6em'>Discover Your Signature Fragrance</span>"
            : "Discover Your Signature Fragrance<br /><span style='font-size:.6em'>اكتشف عطرك الشخصي</span>";
          document.getElementById("birthDateLabel").style.display = this.lang === "ar" ? "none" : "block";
          document.getElementById("birthDateLabelAr").style.display = this.lang === "ar" ? "block" : "none";
          document.getElementById("ingredientPrefLabel").style.display = this.lang === "ar" ? "none" : "block";
          document.getElementById("ingredientPrefLabelAr").style.display = this.lang === "ar" ? "block" : "none";

          console.log('Rendering', this.questionsData.length, 'questions');
          this.questionsData.forEach((q, i) => {
            console.log('Processing question', i + 1);
            const div = document.createElement("div");
            div.className = "question";
            div.setAttribute("role", "region");
            div.setAttribute("aria-labelledby", `q${i}`);
            const text = this.lang === "ar" ? q.ar : q.en;
            div.innerHTML = `<p id="q${i}"><strong>${i + 1}. ${text}</strong></p>`;
            if (!q.options || !Array.isArray(q.options)) {
              console.error(`Invalid options for question ${i + 1}`);
              throw new Error('Invalid question options');
            }
            q.options.forEach((opt, idx) => {
              const label = this.lang === "ar" ? opt[1] : opt[0];
              div.insertAdjacentHTML("beforeend",
                `<label><input type="radio" name="q${i}" value="${idx}" aria-label="${label}"> ${label}</label>`
              );
            });
            wrap.appendChild(div);
          });
          console.log('Questions rendered successfully');
          document.getElementById('questions-fallback').style.display = 'none';
          this.updateProgress();
          this.renderSidebar();
        } catch (e) {
          console.error('Error in renderQuestions:', e);
          document.getElementById('questions-fallback').style.display = 'block';
        }
      },

      updateProgress() {
        console.log('Updating progress at', new Date().toLocaleString());
        try {
          const answered = document.querySelectorAll('input[type="radio"]:checked').length;
          document.getElementById('currentQ').textContent = answered + 1;
        } catch (e) {
          console.error('Error in updateProgress:', e);
        }
      },

      getSeason(birthDate) {
        console.log('Calculating season for birth date:', birthDate);
        try {
          if (!birthDate) return "winter";
          const month = new Date(birthDate).getMonth() + 1;
          if (month >= 3 && month <= 5) return "spring";
          if (month >= 6 && month <= 8) return "summer";
          if (month >= 9 && month <= 11) return "autumn";
          return "winter";
        } catch (e) {
          console.error('Error in getSeason:', e);
          return "winter";
        }
      },

      generateResult() {
        console.log('Starting generateResult at', new Date().toLocaleString());
        try {
          console.log('Resetting lastResult');
          this.lastResult = null;

          console.log('Checking for unanswered questions');
          const unanswered = this.questionsData.find((q, i) => !document.querySelector(`input[name="q${i}"]:checked`));
          if (unanswered) {
            console.log('Unanswered questions found');
            alert(this.lang === "ar" ? "يرجى الإجابة على جميع الأسئلة" : "Please answer all questions");
            return;
          }

          console.log('Resetting scores');
          for (let cat in this.score) {
            this.score[cat] = {};
            this.categories[cat].forEach(trait => this.score[cat][trait] = 0);
          }

          console.log('Processing questionnaire responses');
          this.questionsData.forEach((q, i) => {
            const sel = document.querySelector(`input[name="q${i}"]:checked`);
            if (!sel) {
              console.warn(`No selection for question ${i + 1}`);
              return;
            }
            console.log(`Processing question ${i + 1}, selected value: ${sel.value}`);
            if (!q.options[+sel.value] || !q.options[+sel.value][2]) {
              console.error(`Invalid options for question ${i + 1}, value: ${sel.value}`);
              throw new Error(`Invalid options for question ${i + 1}`);
            }
            const [s, e, f, m] = q.options[+sel.value][2];
            const weights = this.questionWeights[i] || { style: 1, emotion: 1, family: 1, memory: 1 };
            console.log(`Applying weights for question ${i + 1}:`, weights);
            this.score.style[s] += weights.style;
            this.score.emotion[e] += weights.emotion;
            this.score.family[f] += weights.family;
            this.score.memory[m] += weights.memory;
          });

          console.log('Applying birth date adjustments');
          const birthDateInput = document.getElementById('birthDateInput');
          if (!birthDateInput) {
            console.warn('birthDateInput element not found, skipping birth date adjustment');
          } else {
            const birthDate = birthDateInput.value;
            if (birthDate) {
              const season = this.getSeason(birthDate);
              const seasonData = this.seasonMapping[season];
              if (seasonData) {
                console.log(`Boosting family: ${seasonData.family}, emotion: ${seasonData.emotion}`);
                this.score.family[seasonData.family] = (this.score.family[seasonData.family] || 0) + 1;
                this.score.emotion[seasonData.emotion] = (this.score.emotion[seasonData.emotion] || 0) + 0.5;
              } else {
                console.warn(`No season data for ${season}`);
              }
            }
          }

          console.log('Applying cross-category boosts');
          if (this.score.style.elegant > 5 && this.score.emotion.serenity > 5) {
            console.log('Boosting woody and oriental for elegant+serenity');
            this.score.family.woody = (this.score.family.woody || 0) + 2;
            this.score.family.oriental = (this.score.family.oriental || 0) + 1;
          }
          if (this.score.style.bold > 5 && this.score.emotion.passion > 5) {
            console.log('Boosting spicy and citrus for bold+passion');
            this.score.family.spicy = (this.score.family.spicy || 0) + 2;
            this.score.family.citrus = (this.score.family.citrus || 0) + 1;
          }

          console.log('Calculating result percentages');
          const result = {};
          for (let cat in this.score) {
            console.log(`Processing category: ${cat}`);
            const entries = Object.entries(this.score[cat]).sort((a, b) => b[1] - a[1]);
            console.log(`Sorted entries for ${cat}:`, entries);
            const top3 = entries.length >= 3 ? entries.slice(0, 3) : [...entries, ...Array(3 - entries.length).fill([entries[0][0], 0])];
            const [[t1, n1], [t2, n2], [t3, n3]] = top3;
            const sum3 = n1 + n2 + n3 || 1;
            result[cat] = [
              { trait: t1, percent: Math.round(100 * n1 / sum3) },
              { trait: t2, percent: Math.round(100 * n2 / sum3) },
              { trait: t3, percent: 100 - Math.round(100 * n1 / sum3) - Math.round(100 * n2 / sum3) }
            ];
            console.log(`Result for ${cat}:`, result[cat]);
          }

          console.log('Fetching ingredient preference');
          const ingredientPrefInput = document.getElementById('ingredientPref');
          const ingredientPref = ingredientPrefInput && ingredientPrefInput.value ? ingredientPrefInput.value : "both";
          console.log('Ingredient preference:', ingredientPref);

          const noteFilter = note => {
            if (ingredientPref === "both") return true;
            const noteName = note.split(' (')[0];
            const type = this.noteTypes[noteName] || "N";
            return (ingredientPref === "natural" && type === "N") || (ingredientPref === "synthetic" && type === "S");
          };

          const selectNote = (notes, index) => {
            console.log('Selecting note from', notes.length, 'notes at index', index);
            if (!notes || !Array.isArray(notes) || notes.length === 0) {
              console.error('Invalid notes array:', notes);
              throw new Error('Invalid notes array');
            }
            const filtered = notes.filter(noteFilter);
            console.log('Filtered notes:', filtered.length);
            if (filtered.length === 0) {
              console.warn('No notes match ingredient preference, using all notes');
              return notes[index % notes.length] || notes[0];
            }
            return filtered[index % filtered.length] || notes[0];
          };

          console.log('Generating perfume name');
          const perfumeName = birthDateInput && birthDateInput.value
            ? `${this.monthNames[new Date(birthDateInput.value).getMonth() + 1]} ${result.family[0].trait.charAt(0).toUpperCase() + result.family[0].trait.slice(1)}`
            : `Essence ${result.family[0].trait.charAt(0).toUpperCase() + result.family[0].trait.slice(1)}`;

          console.log('Generating narrative');
          const narrative = birthDateInput && birthDateInput.value
            ? `Your ${this.getSeason(birthDateInput.value)} birth infuses this fragrance with ${this.seasonMapping[this.getSeason(birthDateInput.value)].family} elegance, blending ${result.emotion[0].trait} and ${result.style[0].trait} charm.`
            : `A unique fragrance crafted to reflect your ${result.emotion[0].trait} and ${result.style[0].trait} personality.`;

          console.log('Building result HTML');
          let blendsHTML = `<h2>${perfumeName}</h2><p>${narrative}</p>`;
          ["style", "emotion", "family", "memory"].forEach(cat => {
            console.log(`Processing category HTML: ${cat}`);
            blendsHTML += `<h3>${this.lang === "ar"
              ? { "style": "أسلوب", "emotion": "العاطفة", "family": "عائلة العطر", "memory": "الذاكرة" }[cat]
              : cat.charAt(0).toUpperCase() + cat.slice(1)}</h3><ul class="blend-list">`;
            result[cat].forEach(({ trait, percent }) => {
              blendsHTML += `<li>${trait} — ${percent}%</li>`;
            });
            blendsHTML += `</ul>`;
          });

          console.log('Building fragrance pyramid');
          const famBlend = result.family;
          const layers = ["Top Note", "Heart Note", "Base Note"];
          blendsHTML += `<h3>${this.lang === "ar" ? "هرم العطر" : "Fragrance Pyramid"}</h3>`;
          layers.forEach((layer, i) => {
            console.log(`Processing layer: ${layer}`);
            blendsHTML += `<p><strong>${this.lang === "ar"
              ? ["المقدمة", "القلب", "القاعدة"][i]
              : layer}:</strong> `;
            blendsHTML += famBlend.map(({ trait, percent }, idx) => {
              console.log(`Selecting note for family: ${trait}, layer: ${i}, index: ${idx}`);
              if (!this.pyramidNotes[trait] || !this.pyramidNotes[trait][i]) {
                console.error(`Missing notes for family: ${trait}, layer: ${i}`);
                throw new Error(`Missing notes for ${trait}`);
              }
              const note = selectNote(this.pyramidNotes[trait][i], idx);
              return `${note.split(' (')[0]} (${percent}%)`;
            }).join(" • ");
            blendsHTML += `</p>`;
          });

          console.log('Adding disclaimer');
          blendsHTML += `<p class="disclaimer">${this.lang === "ar"
            ? "ملاحظة: هذا المزيج أولي وسيتم تهيئته بواسطة خبير عطور لضمان القضاء على أي مخالفات."
            : "Note: This blend is preliminary and will be refined by a professional perfume nose to ensure the elimination of irregularities."}</p>`;

          console.log('Storing and displaying result');
          this.lastResult = blendsHTML;
          const resultDiv = document.getElementById("result");
          if (!resultDiv) {
            console.error('Result div not found');
            throw new Error('Missing result div');
          }
          resultDiv.innerHTML = blendsHTML;
          console.log('generateResult completed successfully');
        } catch (e) {
          console.error('Error in generateResult:', e.message, e.stack);
          const resultDiv = document.getElementById("result");
          if (resultDiv) {
            resultDiv.innerHTML = this.lang === "ar"
              ? "حدث خطأ، حاول مرة أخرى. افتح وحدة التحكم (F12) وشارك الأخطاء للحصول على المساعدة."
              : "An error occurred, please try again. Open the console (F12) and share the errors for assistance.";
          }
        }
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      console.log('DOM fully loaded, calling Quiz.init at', new Date().toLocaleString());
      Quiz.init();
    });
  </script>
</body>
</html>
